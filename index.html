<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesetrainer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:        #f0f4f8;
            --surface:   #ffffff;
            --surface2:  #f7f9fc;
            --border:    #e2e8f0;
            --accent:    #3b7df8;
            --accent-dk: #2563eb;
            --green:     #16a34a;
            --green-bg:  #dcfce7;
            --red:       #dc2626;
            --red-bg:    #fee2e2;
            --blue:      #2563eb;
            --blue-bg:   #dbeafe;
            --orange:    #ea580c;
            --orange-bg: #ffedd5;
            --muted:     #64748b;
            --text:      #1e293b;
            --text2:     #475569;
            --radius:    14px;
            --radius-sm: 10px;
            --shadow:    0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 16px;
            color: var(--text);
        }

        .container { max-width: 480px; margin: 0 auto; }

        .screen { display: none; }
        .screen.active { display: block; }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 14px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card h1 {
            font-size: 1.9em;
            font-weight: 900;
            color: var(--text);
            text-align: center;
            letter-spacing: -0.5px;
        }

        .card h2 {
            font-size: 0.78em;
            font-weight: 800;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin-bottom: 28px;
            font-size: 0.95em;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 1em;
            font-weight: 700;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 10px;
        }
        .btn:last-child { margin-bottom: 0; }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(59,125,248,0.35);
        }
        .btn-primary:hover:not(:disabled) {
            background: var(--accent-dk);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(59,125,248,0.4);
        }

        .btn-success {
            background: var(--green);
            color: white;
            box-shadow: 0 2px 8px rgba(22,163,74,0.3);
        }
        .btn-success:hover:not(:disabled) {
            filter: brightness(1.08);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }
        .btn-danger:hover:not(:disabled) { filter: brightness(1.08); }

        .btn-ghost {
            background: var(--surface2);
            color: var(--text2);
            border: 1.5px solid var(--border);
        }
        .btn-ghost:hover:not(:disabled) {
            background: var(--border);
            color: var(--text);
        }

        .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none !important; }

        /* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
        .status {
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            margin: 10px 0;
            font-weight: 700;
            font-size: 0.9em;
        }
        .status.info    { background: var(--blue-bg);   color: var(--blue); }
        .status.success { background: var(--green-bg);  color: var(--green); }
        .status.error   { background: var(--red-bg);    color: var(--red); }
        .status.warning { background: var(--orange-bg); color: var(--orange); }

        /* ‚îÄ‚îÄ SESSION HEADER ‚îÄ‚îÄ */
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border-radius: var(--radius-sm);
            padding: 12px 18px;
            margin-bottom: 14px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .page-badge {
            background: var(--accent);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.85em;
        }

        .session-timer {
            font-size: 1em;
            font-weight: 700;
            color: var(--muted);
            font-family: 'Courier New', monospace;
        }

        /* ‚îÄ‚îÄ PHOTO UPLOAD ‚îÄ‚îÄ */
        .photo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        .photo-btn {
            padding: 20px 12px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface2);
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9em;
            font-weight: 700;
            color: var(--text2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .photo-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--blue-bg);
        }
        .photo-btn .btn-icon { font-size: 1.8em; line-height: 1; }

        .preview-img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin: 12px 0;
            display: none;
            border: 1px solid var(--border);
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px;
            background: var(--surface2);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.95em;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            color: var(--text);
            resize: vertical;
            transition: border-color 0.2s;
        }
        textarea::placeholder { color: #a0aec0; }
        textarea:focus { outline: none; border-color: var(--accent); }
        textarea.ocr-done { border-color: var(--green); background: #f0fdf4; }

        .word-count { color: var(--muted); font-size: 0.8em; font-weight: 700; margin-top: 6px; }

        .section-label {
            font-size: 0.78em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        /* ‚îÄ‚îÄ RECORDING ‚îÄ‚îÄ */
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #fff5f5;
            border: 1.5px solid #fca5a5;
            border-radius: var(--radius-sm);
            margin: 12px 0;
        }
        .recording-indicator.show { display: flex; }

        .rec-dot {
            width: 10px; height: 10px;
            background: var(--red);
            border-radius: 50%;
            animation: blink 1s infinite;
            flex-shrink: 0;
        }
        .rec-label { font-weight: 700; font-size: 0.9em; color: var(--red); }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.15; }
        }

        .rec-timer {
            font-size: 1.1em;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            color: var(--text);
            margin-left: auto;
        }

        /* ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ */
        .countdown-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(248,250,252,0.97);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .countdown-overlay.show { display: flex; }
        .countdown-number {
            font-size: 9em;
            font-weight: 900;
            color: var(--accent);
            line-height: 1;
            animation: countPulse 0.85s ease-out;
        }
        .countdown-label {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--muted);
            margin-top: 16px;
            letter-spacing: 0.5px;
        }
        @keyframes countPulse {
            0% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ‚îÄ‚îÄ MINI FEEDBACK ‚îÄ‚îÄ */
        .mini-feedback {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        .mini-metric {
            background: var(--surface2);
            border-radius: var(--radius-sm);
            padding: 18px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .mini-metric .val {
            font-size: 2.4em;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -1px;
        }
        .mini-metric .lbl {
            font-size: 0.72em;
            font-weight: 800;
            color: var(--muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ‚îÄ‚îÄ ERROR PILLS ‚îÄ‚îÄ */
        .error-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        .pill {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 800;
        }
        .pill-green  { background: var(--green-bg);  color: var(--green); }
        .pill-red    { background: var(--red-bg);    color: var(--red); }
        .pill-grey   { background: #f1f5f9; color: var(--muted); }
        .pill-blue   { background: var(--blue-bg);   color: var(--blue); }

        /* ‚îÄ‚îÄ WORD VIEW ‚îÄ‚îÄ */
        .word-view {
            margin-top: 12px;
            line-height: 2.4;
            font-size: 0.95em;
            background: var(--surface2);
            padding: 14px;
            border-radius: var(--radius-sm);
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        .word-correct  { color: var(--green); font-weight: 700; margin-right: 4px; }
        .word-wrong    { color: var(--red);   font-weight: 700; margin-right: 4px; }
        .word-omitted  { color: #94a3b8; font-weight: 600; margin-right: 4px; text-decoration: line-through; }
        .word-added    { color: var(--blue);  font-weight: 600; margin-right: 4px; font-style: italic; }

        .legend {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .legend span { font-size: 0.78em; font-weight: 700; }

        /* ‚îÄ‚îÄ DETAILS ‚îÄ‚îÄ */
        details summary {
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 800;
            color: var(--accent);
            padding: 6px 0;
            list-style: none;
            user-select: none;
        }
        details summary::-webkit-details-marker { display: none; }
        details summary::before {
            content: '‚ñ∂  ';
            font-size: 0.65em;
            transition: transform 0.2s;
            display: inline-block;
        }
        details[open] summary::before { transform: rotate(90deg); }

        /* ‚îÄ‚îÄ SESSION SUMMARY ‚îÄ‚îÄ */
        .summary-hero {
            text-align: center;
            padding: 16px 0 24px;
        }
        .summary-emoji { font-size: 4em; line-height: 1; }
        .summary-message {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--text);
            margin: 12px 0 6px;
            letter-spacing: -0.5px;
        }
        .summary-sub { color: var(--muted); font-size: 0.9em; font-weight: 600; }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        .stat-box {
            background: var(--surface2);
            border-radius: var(--radius-sm);
            padding: 18px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-box .val {
            font-size: 2.2em;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -1px;
        }
        .stat-box .lbl {
            font-size: 0.72em;
            font-weight: 800;
            color: var(--muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pages-list {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            margin-top: 4px;
        }
        .pages-list h3 {
            font-size: 0.78em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 12px;
        }
        .page-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }
        .page-row:last-child { border-bottom: none; }
        .page-num {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85em;
            font-weight: 800;
            flex-shrink: 0;
        }
        .page-stats { flex: 1; display: flex; gap: 14px; }
        .page-stat { font-size: 0.88em; font-weight: 700; color: var(--text2); }
        .page-stat strong { color: var(--text); }

        .divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 16px 0;
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .card { padding: 20px; }
            .btn { padding: 13px; }
            .countdown-number { font-size: 7em; }
        }
    </style>

</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     COUNTDOWN OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
    <div class="countdown-label">Gleich geht's los!</div>
</div>

<div class="container">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 1: START
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screenStart">
    <div class="card" style="margin-top: 32px;">
        <div class="start-logo">
            <span style="font-size:4em;display:block;margin-bottom:8px;">üìñ</span>
        </div>
        <h1>Lesetrainer</h1>
        <p class="subtitle" style="margin-top:8px;">Lesen √ºben & Fortschritte messen</p>
        <button class="btn btn-primary" onclick="startSession()" style="margin-top:8px;">
            ‚ñ∂
            Session starten
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 2: SEITE LESEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenPage">

    <div class="session-header">
        <span class="page-badge" id="pageBadge">Seite 1</span>
        <span class="session-timer" id="sessionTimer">00:00</span>
    </div>

    <!-- Step A: Foto -->
    <div class="card" id="stepPhoto">
        <h2>Schritt 1 ‚Äî Text erfassen</h2>
        <div class="photo-buttons">
            <label class="photo-btn" for="cameraInput">
                <span class="btn-icon">üì∑</span>
                Kamera
            </label>
            <label class="photo-btn" for="galleryInput">
                <span class="btn-icon">üñºÔ∏è</span>
                Galerie
            </label>
        </div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
        <input type="file" id="galleryInput" accept="image/*" style="display:none">

        <div id="ocrStatus"></div>
        <img id="previewImg" class="preview-img">

        <div class="section-label" style="margin-top:14px;">Referenztext</div>
        <textarea id="referenceText"
            placeholder="Text erscheint hier nach dem Foto... oder direkt eintippen"></textarea>
        <div class="word-count" id="wordCount">0 W√∂rter</div>

        <button class="btn btn-primary" id="toRecordBtn" onclick="goToRecord()" disabled style="margin-top:14px;">
            üé§ Aufnahme starten
        </button>
        <button class="btn btn-ghost" onclick="goToRecord()">
            Ohne Foto weitermachen
        </button>
    </div>

    <!-- Step B: Aufnehmen -->
    <div class="card" id="stepRecord" style="display:none">
        <h2>Schritt 2 ‚Äî Vorlesen</h2>

        <div class="recording-indicator" id="recIndicator">
            <div class="rec-dot"></div>
            <span class="rec-label">Aufnahme l√§uft</span>
            <span class="rec-timer" id="recTimer">00:00</span>
        </div>

        <div id="recordStatus"></div>

        <div style="display:flex; gap:10px; margin-top:8px;">
            <button class="btn btn-success" id="startRecBtn" onclick="startRecording()" style="flex:1">
                ‚ñ∂ Los lesen!
            </button>
            <button class="btn btn-danger" id="stopRecBtn" onclick="stopRecording()" style="flex:1; display:none">
                ‚ñ† Fertig
            </button>
        </div>

        <button class="btn btn-ghost" onclick="backToPhoto()" style="margin-top:8px">
            ‚Üê Zur√ºck
        </button>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 3: MINI FEEDBACK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenFeedback">

    <div class="session-header">
        <span class="page-badge" id="feedbackPageBadge">Seite 1</span>
        <span class="session-timer" id="feedbackTimer">00:00</span>
    </div>

    <div class="card">
        <h2 id="feedbackTitle">Seite 1 geschafft!</h2>

        <div class="mini-feedback">
            <div class="mini-metric">
                <div class="val" id="fbWpm">-</div>
                <div class="lbl">W√∂rter / Min</div>
            </div>
            <div class="mini-metric">
                <div class="val" id="fbAccuracy">-</div>
                <div class="lbl">Genauigkeit</div>
            </div>
        </div>

        <div id="fbMessage" class="status info"></div>

        <div id="fbErrorSummary" class="error-pills" style="display:none;"></div>

        <details id="fbDetails" style="margin-top:14px;">
            <summary>Wort-f√ºr-Wort Analyse</summary>
            <div id="fbWordView" class="word-view"></div>
            <div class="legend" style="margin-top:10px;">
                <span style="color:var(--green);">‚óè richtig</span>
                <span style="color:var(--red);">‚óè falsch</span>
                <span style="color:var(--muted);">‚óè ausgelassen</span>
                <span style="color:var(--blue);">‚óè hinzugef√ºgt</span>
            </div>
        </details>

        <hr class="divider" style="margin-top:16px;">

        <button class="btn btn-primary" onclick="nextPage()">
            ‚Üí N√§chste Seite
        </button>
        <button class="btn btn-ghost" onclick="retryPage()">
            ‚Ü∫ Nochmal lesen
        </button>
        <button class="btn btn-ghost" onclick="endSession()">
            ‚úì Session beenden
        </button>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 4: SESSION SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenSummary">
    <div class="card">
        <div class="summary-hero">
            <div class="summary-emoji" id="summaryEmoji">üåü</div>
            <div class="summary-message" id="summaryMessage">Super gemacht!</div>
            <div class="summary-sub" id="summarySub"></div>
        </div>

        <div class="summary-stats">
            <div class="stat-box">
                <div class="val" id="sumPages">-</div>
                <div class="lbl">Seiten</div>
            </div>
            <div class="stat-box">
                <div class="val" id="sumDuration">-</div>
                <div class="lbl">Minuten</div>
            </div>
            <div class="stat-box">
                <div class="val" id="sumWpm">-</div>
                <div class="lbl">√ò W / Min</div>
            </div>
            <div class="stat-box">
                <div class="val" id="sumAccuracy">-</div>
                <div class="lbl">√ò Genauigkeit</div>
            </div>
        </div>

        <div class="pages-list">
            <h3>Pro Seite</h3>
            <div id="pagesList"></div>
        </div>

        <div class="pages-list" id="frequentErrorsSection" style="display:none; margin-top:16px;">
            <h3>H√§ufige Fehler</h3>
            <div id="frequentErrorsList"></div>
        </div>

        <button class="btn btn-primary" onclick="newSession()" style="margin-top:20px">
            ‚Ü∫ Neue Session
        </button>
    </div>
</div>

</div><!-- /container -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
    currentPage: 1,
    sessionStartTime: null,
    sessionTimerInterval: null,
    recStartTime: null,
    recTimerInterval: null,
    mediaRecorder: null,
    audioChunks: [],
    referenceWords: [],
    pages: [], // {wpm, accuracy, duration, wordCount, errors, alignment}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startSessionTimer() {
    state.sessionStartTime = Date.now();
    state.sessionTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - state.sessionStartTime) / 1000);
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        const display = `${m}:${s}`;
        document.getElementById('sessionTimer').textContent = display;
        document.getElementById('feedbackTimer').textContent = display;
    }, 1000);
}

function stopSessionTimer() {
    clearInterval(state.sessionTimerInterval);
}

function getSessionDurationMinutes() {
    return (Date.now() - state.sessionStartTime) / 60000;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECORDING TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startRecTimer() {
    state.recStartTime = Date.now();
    state.recTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - state.recStartTime) / 1000);
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('recTimer').textContent = `${m}:${s}`;
    }, 1000);
}

function stopRecTimer() {
    clearInterval(state.recTimerInterval);
}

function getRecDurationSeconds() {
    return (Date.now() - state.recStartTime) / 1000;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startSession() {
    state.currentPage = 1;
    state.pages = [];
    startSessionTimer();
    loadPageScreen();
    showScreen('screenPage');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD PAGE SCREEN (reset for new page)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadPageScreen() {
    // Update badge
    document.getElementById('pageBadge').textContent = `Seite ${state.currentPage}`;

    // Reset photo step
    document.getElementById('stepPhoto').style.display = 'block';
    document.getElementById('stepRecord').style.display = 'none';

    // Reset textarea
    const ta = document.getElementById('referenceText');
    ta.value = '';
    ta.className = '';
    ta.style.borderColor = '';
    ta.style.background = '';
    document.getElementById('wordCount').textContent = '0 W√∂rter';

    // Reset photo preview
    document.getElementById('previewImg').style.display = 'none';
    document.getElementById('ocrStatus').innerHTML = '';

    // Reset record button
    document.getElementById('toRecordBtn').disabled = true;

    // Reset file inputs
    document.getElementById('cameraInput').value = '';
    document.getElementById('galleryInput').value = '';

    // Reset audio
    state.audioChunks = [];
    state.referenceWords = [];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEXT INPUT ‚Üí ENABLE RECORD BTN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('referenceText').addEventListener('input', function() {
    const words = this.value.trim().split(/\s+/).filter(w => w.length > 0);
    document.getElementById('wordCount').textContent = `${words.length} W√∂rter`;
    document.getElementById('toRecordBtn').disabled = words.length < 3;
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO / OCR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('cameraInput').addEventListener('change', e => handleImage(e.target.files[0]));
document.getElementById('galleryInput').addEventListener('change', e => handleImage(e.target.files[0]));

function compressImage(file, maxWidth = 1600, quality = 0.8) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
    });
}

async function handleImage(file) {
    if (!file) return;

    // Preview
    const preview = document.getElementById('previewImg');
    preview.src = URL.createObjectURL(file);
    preview.style.display = 'block';

    showStatus('üîß Bild wird verarbeitet...', 'info', 'ocrStatus');

    try {
        const compressed = await compressImage(file);
        showStatus('üìñ Text wird erkannt...', 'info', 'ocrStatus');

        const fd = new FormData();
        fd.append('image', compressed, 'image.jpg');

        const res = await fetch('/api/ocr', { method: 'POST', body: fd });
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.details || err.error || 'OCR fehlgeschlagen');
        }

        const data = await res.json();
        const text = data.text.trim();

        if (text) {
            const ta = document.getElementById('referenceText');
            ta.value = text;
            ta.classList.add('ocr-done');
            const words = text.split(/\s+/).filter(w => w.length > 0);
            document.getElementById('wordCount').textContent = `${words.length} W√∂rter`;
            document.getElementById('toRecordBtn').disabled = false;
            showStatus(`‚úÖ ${words.length} W√∂rter erkannt ‚Äì bei Bedarf korrigieren`, 'success', 'ocrStatus');
        } else {
            showStatus('‚ö†Ô∏è Kein Text gefunden. Bitte nochmal versuchen oder manuell eingeben.', 'warning', 'ocrStatus');
        }
    } catch (err) {
        showStatus('‚ùå ' + err.message, 'error', 'ocrStatus');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goToRecord() {
    const text = document.getElementById('referenceText').value.trim();
    if (!text) return;
    state.referenceWords = normalizeText(text).split(/\s+/).filter(w => w.length > 0);

    document.getElementById('stepPhoto').style.display = 'none';
    document.getElementById('stepRecord').style.display = 'block';

    // Reset record UI
    document.getElementById('startRecBtn').style.display = 'block';
    document.getElementById('stopRecBtn').style.display = 'none';
    document.getElementById('recIndicator').classList.remove('show');
    document.getElementById('recTimer').textContent = '00:00';
    document.getElementById('recordStatus').innerHTML = '';
}

function backToPhoto() {
    document.getElementById('stepRecord').style.display = 'none';
    document.getElementById('stepPhoto').style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WAKE LOCK (Bildschirm wach halten)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let wakeLock = null;

async function requestWakeLock() {
    // Keep screen on
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock aktiviert');
        } catch (err) {
            console.warn('Wake Lock fehlgeschlagen:', err);
        }
    }
    // Lock screen orientation to portrait
    if (screen.orientation && screen.orientation.lock) {
        try {
            await screen.orientation.lock('portrait');
            console.log('Orientation auf Portrait gesperrt');
        } catch (err) {
            console.warn('Orientation Lock fehlgeschlagen:', err);
        }
    }
}

async function releaseWakeLock() {
    if (wakeLock) {
        try {
            await wakeLock.release();
            wakeLock = null;
            console.log('Wake Lock freigegeben');
        } catch (err) {
            console.warn('Wake Lock release fehlgeschlagen:', err);
        }
    }
    // Unlock orientation
    if (screen.orientation && screen.orientation.unlock) {
        try {
            screen.orientation.unlock();
        } catch (err) {
            console.warn('Orientation unlock fehlgeschlagen:', err);
        }
    }
}

// Re-acquire wake lock if page becomes visible again (e.g. after tab switch)
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECORDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startRecording() {
    state.audioChunks = [];

    // Request wake lock FIRST before countdown (needs user gesture context)
    await requestWakeLock();

    // Countdown
    const overlay = document.getElementById('countdownOverlay');
    const num = document.getElementById('countdownNumber');
    overlay.classList.add('show');
    for (let i = 3; i > 0; i--) {
        num.textContent = i;
        await sleep(1000);
    }
    num.textContent = 'LOS!';
    await sleep(600);
    overlay.classList.remove('show');

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });

        // Pick best supported audio format
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
            ? 'audio/webm;codecs=opus'
            : MediaRecorder.isTypeSupported('audio/webm')
            ? 'audio/webm'
            : 'audio/mp4';

        state.mediaRecorder = new MediaRecorder(stream, { mimeType });
        state.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) state.audioChunks.push(e.data); };
        state.mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(t => t.stop());
            await processRecording();
        };

        state.mediaRecorder.start(1000); // Collect data every second (more robust)
        startRecTimer();

        document.getElementById('startRecBtn').style.display = 'none';
        const stopBtn = document.getElementById('stopRecBtn');
        stopBtn.style.display = 'block';
        stopBtn.disabled = true;
        stopBtn.textContent = '‚ñ† Bitte warten...';
        document.getElementById('recIndicator').classList.add('show');
        showStatus('üé§ Aufnahme l√§uft ‚Äì jetzt vorlesen!', 'success', 'recordStatus');

        // Enable stop button after 3 seconds minimum
        setTimeout(() => {
            stopBtn.disabled = false;
            stopBtn.textContent = '‚ñ† Fertig';
        }, 3000);

    } catch (err) {
        releaseWakeLock();
        showStatus('‚ùå Mikrofon-Zugriff fehlgeschlagen: ' + err.message, 'error', 'recordStatus');
    }
}

function stopRecording() {
    if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
        state.mediaRecorder.stop();
        stopRecTimer();
        releaseWakeLock();

        const stopBtn = document.getElementById('stopRecBtn');
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = '‚ñ† Fertig';
        document.getElementById('recIndicator').classList.remove('show');
        showStatus('‚è≥ Wird ausgewertet...', 'info', 'recordStatus');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RETRY PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function retryPage() {
    // Remove last page result (we're redoing it)
    if (state.pages.length > 0 && state.pages[state.pages.length - 1].page === state.currentPage) {
        state.pages.pop();
    }
    // Go back to recording step (keep the text/photo)
    showScreen('screenPage');
    document.getElementById('stepPhoto').style.display = 'none';
    document.getElementById('stepRecord').style.display = 'block';
    document.getElementById('startRecBtn').style.display = 'block';
    const stopBtn = document.getElementById('stopRecBtn');
    stopBtn.style.display = 'none';
    stopBtn.disabled = false;
    stopBtn.textContent = '‚ñ† Fertig';
    document.getElementById('recIndicator').classList.remove('show');
    document.getElementById('recTimer').textContent = '00:00';
    document.getElementById('recordStatus').innerHTML = '';
    state.audioChunks = [];
}

async function processRecording() {
    const durationSeconds = getRecDurationSeconds();

    // Check if we have audio data
    if (state.audioChunks.length === 0) {
        showStatus('‚ö†Ô∏è Keine Aufnahme gefunden. Bitte nochmal versuchen.', 'warning', 'recordStatus');
        document.getElementById('startRecBtn').style.display = 'block';
        return;
    }

    const blob = new Blob(state.audioChunks, { type: state.mediaRecorder?.mimeType || 'audio/webm' });
    
    // Check minimum size (corrupt/empty files are usually < 1KB)
    if (blob.size < 1000) {
        showStatus('‚ö†Ô∏è Aufnahme zu kurz oder leer. Bitte nochmal versuchen.', 'warning', 'recordStatus');
        document.getElementById('startRecBtn').style.display = 'block';
        return;
    }

    console.log('Audio blob size:', blob.size, 'bytes, duration:', durationSeconds, 's');

    try {
        const fd = new FormData();
        fd.append('audio', blob, 'recording.webm');

        showStatus('‚è≥ Wird ausgewertet...', 'info', 'recordStatus');

        const res = await fetch('/api/transcribe', { method: 'POST', body: fd });
        
        if (!res.ok) {
            // Try to parse error as JSON, fallback to status text
            let errMsg = `Server Fehler (${res.status})`;
            try {
                const errData = await res.json();
                errMsg = errData.error || errData.message || errMsg;
            } catch {
                const errText = await res.text();
                errMsg = errText.substring(0, 100) || errMsg;
            }
            throw new Error(errMsg);
        }

        const data = await res.json();
        const rawTranscript = data.text.trim();
        const recognized = normalizeText(rawTranscript).split(/\s+/).filter(w => w.length > 0);

        const wpm = Math.round(recognized.length / (durationSeconds / 60));
        
        // Full alignment analysis
        const alignment = alignWords(state.referenceWords, recognized);
        const accuracy = calculateAccuracyFromAlignment(alignment, state.referenceWords.length);

        // Save page result with full error data
        state.pages.push({
            page: state.currentPage,
            wpm,
            accuracy,
            duration: Math.round(durationSeconds),
            wordCount: state.referenceWords.length,
            alignment,
            rawTranscript
        });

        showFeedback(wpm, accuracy, alignment);

    } catch (err) {
        console.error('Processing error:', err);
        showStatus('‚ùå ' + err.message + ' ‚Äì Nochmal versuchen?', 'error', 'recordStatus');
        document.getElementById('startRecBtn').style.display = 'block';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MINI FEEDBACK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showFeedback(wpm, accuracy, alignment) {
    document.getElementById('feedbackPageBadge').textContent = `Seite ${state.currentPage}`;
    document.getElementById('feedbackTitle').textContent = `Seite ${state.currentPage} geschafft!`;
    document.getElementById('fbWpm').textContent = wpm;
    document.getElementById('fbAccuracy').textContent = accuracy + '%';

    // Count error types
    const substitutions = alignment.filter(a => a.type === 'substitution').length;
    const omissions     = alignment.filter(a => a.type === 'omission').length;
    const additions     = alignment.filter(a => a.type === 'addition').length;
    const correct       = alignment.filter(a => a.type === 'correct').length;
    const totalErrors   = substitutions + omissions;

    // Motivational message
    let msg = '';
    if (accuracy >= 95) msg = 'Fantastisch! Fast fehlerfrei!';
    else if (accuracy >= 85) msg = 'Sehr gut! Weiter so!';
    else if (accuracy >= 70) msg = 'Gut gemacht! √úb weiter!';
    else msg = 'Weiterlesen macht besser!';
    if (wpm > 150) msg += ' Super schnell!';

    document.getElementById('fbMessage').textContent = msg;
    document.getElementById('fbMessage').className = 'status ' + (accuracy >= 85 ? 'success' : 'info');

    // Error pills
    const errSummary = document.getElementById('fbErrorSummary');
    if (correct > 0 || totalErrors > 0 || additions > 0) {
        const pills = [];
        if (correct > 0)       pills.push(`<span class="pill pill-green">${correct} richtig</span>`);
        if (substitutions > 0) pills.push(`<span class="pill pill-red">${substitutions} falsch</span>`);
        if (omissions > 0)     pills.push(`<span class="pill pill-grey">${omissions} ausgelassen</span>`);
        if (additions > 0)     pills.push(`<span class="pill pill-blue">${additions} hinzugef√ºgt</span>`);
        errSummary.innerHTML = pills.join('');
        errSummary.style.display = 'flex';
    } else {
        errSummary.style.display = 'none';
    }

    // Word-by-word view with new CSS classes
    const wordView = document.getElementById('fbWordView');
    wordView.innerHTML = alignment.map(a => {
        switch(a.type) {
            case 'correct':
                return `<span class="word-correct">${a.ref}</span>`;
            case 'substitution':
                return `<span class="word-wrong" title="gesagt: ${a.rec}"><s>${a.ref}</s>‚Üí${a.rec}</span>`;
            case 'omission':
                return `<span class="word-omitted">[${a.ref}]</span>`;
            case 'addition':
                return `<span class="word-added">+${a.rec}</span>`;
            default: return '';
        }
    }).join(' ');

    showScreen('screenFeedback');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORD ALIGNMENT (Needleman-Wunsch)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Returns array of {type, ref, rec} for each word
// types: 'correct' | 'substitution' | 'omission' | 'addition'
function alignWords(reference, recognized) {
    const m = reference.length;
    const n = recognized.length;

    // Limit length for performance
    const ref = reference.slice(0, Math.min(m, 300));
    const rec = recognized.slice(0, Math.min(n, 300));

    // Build DP table
    const GAP = -1;
    const MATCH = 2;
    const MISMATCH = -1;

    const dp = Array.from({length: ref.length + 1}, (_, i) =>
        Array.from({length: rec.length + 1}, (_, j) => {
            if (i === 0) return j * GAP;
            if (j === 0) return i * GAP;
            return 0;
        })
    );

    for (let i = 1; i <= ref.length; i++) {
        for (let j = 1; j <= rec.length; j++) {
            const score = ref[i-1] === rec[j-1] ? MATCH : MISMATCH;
            dp[i][j] = Math.max(
                dp[i-1][j-1] + score,  // match/mismatch
                dp[i-1][j] + GAP,       // omission (ref word skipped)
                dp[i][j-1] + GAP        // addition (extra word spoken)
            );
        }
    }

    // Traceback
    const result = [];
    let i = ref.length, j = rec.length;

    while (i > 0 || j > 0) {
        if (i > 0 && j > 0) {
            const score = ref[i-1] === rec[j-1] ? MATCH : MISMATCH;
            if (dp[i][j] === dp[i-1][j-1] + score) {
                result.unshift({
                    type: ref[i-1] === rec[j-1] ? 'correct' : 'substitution',
                    ref: ref[i-1],
                    rec: rec[j-1]
                });
                i--; j--;
                continue;
            }
        }
        if (i > 0 && dp[i][j] === dp[i-1][j] + GAP) {
            result.unshift({ type: 'omission', ref: ref[i-1], rec: null });
            i--;
        } else {
            result.unshift({ type: 'addition', ref: null, rec: rec[j-1] });
            j--;
        }
    }

    return result;
}

function calculateAccuracyFromAlignment(alignment, refLength) {
    if (refLength === 0) return 0;
    const correct = alignment.filter(a => a.type === 'correct').length;
    return Math.round((correct / refLength) * 100);
}

function calculateAccuracy(reference, recognized) {
    const alignment = alignWords(reference, recognized);
    return calculateAccuracyFromAlignment(alignment, reference.length);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEXT PAGE / END SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nextPage() {
    state.currentPage++;
    loadPageScreen();
    showScreen('screenPage');
}

function endSession() {
    stopSessionTimer();
    buildSummary();
    showScreen('screenSummary');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSummary() {
    const pages = state.pages;
    if (pages.length === 0) return;

    const totalDurationMin = getSessionDurationMinutes();
    const avgWpm = Math.round(pages.reduce((s, p) => s + p.wpm, 0) / pages.length);
    const avgAccuracy = Math.round(pages.reduce((s, p) => s + p.accuracy, 0) / pages.length);

    // Emoji & message based on performance
    let emoji, message, sub;
    if (avgAccuracy >= 95 && avgWpm >= 100) {
        emoji = 'üèÜ'; message = 'Unglaublich gut!';
        sub = 'Ein wirklich beeindruckendes Ergebnis!';
    } else if (avgAccuracy >= 85) {
        emoji = '‚≠ê'; message = 'Super gemacht!';
        sub = 'Du wirst von Mal zu Mal besser!';
    } else if (avgAccuracy >= 70) {
        emoji = 'üí™'; message = 'Gut gelesen!';
        sub = 'Mit jedem √úben wird es leichter!';
    } else {
        emoji = 'üìñ'; message = 'Weiter √ºben!';
        sub = 'Regelm√§√üiges Lesen macht den Unterschied!';
    }

    document.getElementById('summaryEmoji').textContent = emoji;
    document.getElementById('summaryMessage').textContent = message;
    document.getElementById('summarySub').textContent = sub;

    document.getElementById('sumPages').textContent = pages.length;
    document.getElementById('sumDuration').textContent = Math.round(totalDurationMin);
    document.getElementById('sumWpm').textContent = avgWpm;
    document.getElementById('sumAccuracy').textContent = avgAccuracy + '%';

    // Pages list with error counts
    const list = document.getElementById('pagesList');
    list.innerHTML = pages.map(p => {
        const subs = p.alignment ? p.alignment.filter(a => a.type === 'substitution').length : 0;
        const omis = p.alignment ? p.alignment.filter(a => a.type === 'omission').length : 0;
        const errorStr = (subs + omis) > 0
            ? `<span style="color:#dc3545; font-size:0.85em;">
                ${subs > 0 ? `üî¥${subs}` : ''} ${omis > 0 ? `‚ö´${omis}` : ''}
               </span>`
            : `<span style="color:#28a745; font-size:0.85em;">‚úÖ</span>`;
        return `
            <div class="page-row">
                <div class="page-num">${p.page}</div>
                <div class="page-stats">
                    <div class="page-stat">‚ö° <strong>${p.wpm}</strong> W/min</div>
                    <div class="page-stat">üéØ <strong>${p.accuracy}%</strong></div>
                    <div class="page-stat">${errorStr}</div>
                </div>
            </div>`;
    }).join('');

    // Collect all errors across pages
    const allErrors = {};
    pages.forEach(p => {
        if (!p.alignment) return;
        p.alignment
            .filter(a => a.type === 'substitution' || a.type === 'omission')
            .forEach(a => {
                const word = a.ref;
                allErrors[word] = (allErrors[word] || 0) + 1;
            });
    });

    const topErrors = Object.entries(allErrors)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    const errSection = document.getElementById('frequentErrorsSection');
    const errList = document.getElementById('frequentErrorsList');

    if (topErrors.length > 0) {
        errList.innerHTML = topErrors.map(([word, count]) =>
            `<div class="page-row">
                <div style="flex:1; font-weight:600; color:var(--text2);">${word}</div>
                <div style="color:#dc3545; font-size:0.9em;">${count}√ó Fehler</div>
            </div>`
        ).join('');
        errSection.style.display = 'block';
    } else {
        errSection.style.display = 'none';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newSession() {
    showScreen('screenStart');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function normalizeText(text) {
    return text
        .toLowerCase()
        // Normalize German umlauts (in case of encoding differences)
        .replace(/√§/g, '√§').replace(/√∂/g, '√∂').replace(/√º/g, '√º')
        .replace(/√Ñ/g, '√§').replace(/√ñ/g, '√∂').replace(/√ú/g, '√º')
        .replace(/√ü/g, 'ss')
        // Remove all punctuation and special characters
        .replace(/[.,\/#!$%\^&\*;:{}=_`~()?"'¬ª¬´‚Äû"\-‚Äì‚Äî]/g, ' ')
        // Remove line breaks and tabs (treat as spaces)
        .replace(/[\r\n\t]/g, ' ')
        // Normalize multiple spaces
        .replace(/\s+/g, ' ')
        .trim();
}

function showStatus(msg, type, elementId) {
    const el = document.getElementById(elementId);
    if (el) el.innerHTML = `<div class="status ${type}">${msg}</div>`;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
