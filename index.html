<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesetrainer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:        #f0f4f8;
            --surface:   #ffffff;
            --surface2:  #f7f9fc;
            --border:    #e2e8f0;
            --accent:    #3b7df8;
            --accent-dk: #2563eb;
            --green:     #16a34a;
            --green-bg:  #dcfce7;
            --red:       #dc2626;
            --red-bg:    #fee2e2;
            --blue:      #2563eb;
            --blue-bg:   #dbeafe;
            --orange:    #ea580c;
            --orange-bg: #ffedd5;
            --muted:     #64748b;
            --text:      #1e293b;
            --text2:     #475569;
            --radius:    14px;
            --radius-sm: 10px;
            --shadow:    0 1px 3px rgba(0,0,0,0.08), 0 4px 16px rgba(0,0,0,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            padding: 16px;
            color: var(--text);
        }

        .container { max-width: 480px; margin: 0 auto; }

        .screen { display: none; }
        .screen.active { display: block; }

        /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 14px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card h1 {
            font-size: 1.9em;
            font-weight: 900;
            color: var(--text);
            text-align: center;
            letter-spacing: -0.5px;
        }

        .card h2 {
            font-size: 0.78em;
            font-weight: 800;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .subtitle {
            text-align: center;
            color: var(--muted);
            margin-bottom: 28px;
            font-size: 0.95em;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 1em;
            font-weight: 700;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 10px;
        }
        .btn:last-child { margin-bottom: 0; }

        .btn-primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 8px rgba(59,125,248,0.35);
        }
        .btn-primary:hover:not(:disabled) {
            background: var(--accent-dk);
            transform: translateY(-1px);
            box-shadow: 0 4px 14px rgba(59,125,248,0.4);
        }

        .btn-success {
            background: var(--green);
            color: white;
            box-shadow: 0 2px 8px rgba(22,163,74,0.3);
        }
        .btn-success:hover:not(:disabled) {
            filter: brightness(1.08);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }
        .btn-danger:hover:not(:disabled) { filter: brightness(1.08); }

        .btn-ghost {
            background: var(--surface2);
            color: var(--text2);
            border: 1.5px solid var(--border);
        }
        .btn-ghost:hover:not(:disabled) {
            background: var(--border);
            color: var(--text);
        }

        .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none !important; }

        /* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
        .status {
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            margin: 10px 0;
            font-weight: 700;
            font-size: 0.9em;
        }
        .status.info    { background: var(--blue-bg);   color: var(--blue); }
        .status.success { background: var(--green-bg);  color: var(--green); }
        .status.error   { background: var(--red-bg);    color: var(--red); }
        .status.warning { background: var(--orange-bg); color: var(--orange); }

        /* ‚îÄ‚îÄ SESSION HEADER ‚îÄ‚îÄ */
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            border-radius: var(--radius-sm);
            padding: 12px 18px;
            margin-bottom: 14px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .page-badge {
            background: var(--accent);
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 0.85em;
        }

        .session-timer {
            font-size: 1em;
            font-weight: 700;
            color: var(--muted);
            font-family: 'Courier New', monospace;
        }

        /* ‚îÄ‚îÄ PHOTO UPLOAD ‚îÄ‚îÄ */
        .photo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }

        .photo-btn {
            padding: 20px 12px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            background: var(--surface2);
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
            font-family: 'Nunito', sans-serif;
            font-size: 0.9em;
            font-weight: 700;
            color: var(--text2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .photo-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--blue-bg);
        }
        .photo-btn .btn-icon { font-size: 1.8em; line-height: 1; }

        .preview-img {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin: 12px 0;
            display: none;
            border: 1px solid var(--border);
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px;
            background: var(--surface2);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.95em;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            color: var(--text);
            resize: vertical;
            transition: border-color 0.2s;
        }
        textarea::placeholder { color: #a0aec0; }
        textarea:focus { outline: none; border-color: var(--accent); }
        textarea.ocr-done { border-color: var(--green); background: #f0fdf4; }

        .word-count { color: var(--muted); font-size: 0.8em; font-weight: 700; margin-top: 6px; }

        .section-label {
            font-size: 0.78em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        /* ‚îÄ‚îÄ RECORDING ‚îÄ‚îÄ */
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: #fff5f5;
            border: 1.5px solid #fca5a5;
            border-radius: var(--radius-sm);
            margin: 12px 0;
        }
        .recording-indicator.show { display: flex; }

        .rec-dot {
            width: 10px; height: 10px;
            background: var(--red);
            border-radius: 50%;
            animation: blink 1s infinite;
            flex-shrink: 0;
        }
        .rec-label { font-weight: 700; font-size: 0.9em; color: var(--red); }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.15; }
        }

        .rec-timer {
            font-size: 1.1em;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            color: var(--text);
            margin-left: auto;
        }

        /* ‚îÄ‚îÄ COUNTDOWN ‚îÄ‚îÄ */
        .countdown-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(248,250,252,0.97);
            z-index: 100;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .countdown-overlay.show { display: flex; }
        .countdown-number {
            font-size: 9em;
            font-weight: 900;
            color: var(--accent);
            line-height: 1;
            animation: countPulse 0.85s ease-out;
        }
        .countdown-label {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--muted);
            margin-top: 16px;
            letter-spacing: 0.5px;
        }
        @keyframes countPulse {
            0% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ‚îÄ‚îÄ MINI FEEDBACK ‚îÄ‚îÄ */
        .mini-feedback {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        .mini-metric {
            background: var(--surface2);
            border-radius: var(--radius-sm);
            padding: 18px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .mini-metric .val {
            font-size: 2.4em;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -1px;
        }
        .mini-metric .lbl {
            font-size: 0.72em;
            font-weight: 800;
            color: var(--muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ‚îÄ‚îÄ ERROR PILLS ‚îÄ‚îÄ */
        .error-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        .pill {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 800;
        }
        .pill-green  { background: var(--green-bg);  color: var(--green); }
        .pill-red    { background: var(--red-bg);    color: var(--red); }
        .pill-grey   { background: #f1f5f9; color: var(--muted); }
        .pill-blue   { background: var(--blue-bg);   color: var(--blue); }

        /* ‚îÄ‚îÄ WORD VIEW ‚îÄ‚îÄ */
        .word-view {
            margin-top: 12px;
            line-height: 2.4;
            font-size: 0.95em;
            background: var(--surface2);
            padding: 14px;
            border-radius: var(--radius-sm);
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        .word-correct  { color: var(--green); font-weight: 700; margin-right: 4px; }
        .word-wrong    { color: var(--red);   font-weight: 700; margin-right: 4px; }
        .word-omitted  { color: #94a3b8; font-weight: 600; margin-right: 4px; text-decoration: line-through; }
        .word-added    { color: var(--blue);  font-weight: 600; margin-right: 4px; font-style: italic; }

        .legend {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .legend span { font-size: 0.78em; font-weight: 700; }

        /* ‚îÄ‚îÄ DETAILS ‚îÄ‚îÄ */
        details summary {
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 800;
            color: var(--accent);
            padding: 6px 0;
            list-style: none;
            user-select: none;
        }
        details summary::-webkit-details-marker { display: none; }
        details summary::before {
            content: '‚ñ∂  ';
            font-size: 0.65em;
            transition: transform 0.2s;
            display: inline-block;
        }
        details[open] summary::before { transform: rotate(90deg); }

        /* ‚îÄ‚îÄ SESSION SUMMARY ‚îÄ‚îÄ */
        .summary-hero {
            text-align: center;
            padding: 16px 0 24px;
        }
        .summary-emoji { font-size: 4em; line-height: 1; }
        .summary-message {
            font-size: 1.5em;
            font-weight: 900;
            color: var(--text);
            margin: 12px 0 6px;
            letter-spacing: -0.5px;
        }
        .summary-sub { color: var(--muted); font-size: 0.9em; font-weight: 600; }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        .stat-box {
            background: var(--surface2);
            border-radius: var(--radius-sm);
            padding: 18px;
            text-align: center;
            border: 1px solid var(--border);
        }
        .stat-box .val {
            font-size: 2.2em;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -1px;
        }
        .stat-box .lbl {
            font-size: 0.72em;
            font-weight: 800;
            color: var(--muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pages-list {
            border-top: 1px solid var(--border);
            padding-top: 16px;
            margin-top: 4px;
        }
        .pages-list h3 {
            font-size: 0.78em;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--muted);
            margin-bottom: 12px;
        }
        .page-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            gap: 12px;
        }
        .page-row:last-child { border-bottom: none; }
        .page-num {
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.85em;
            font-weight: 800;
            flex-shrink: 0;
        }
        .page-stats { flex: 1; display: flex; gap: 14px; }
        .page-stat { font-size: 0.88em; font-weight: 700; color: var(--text2); }
        .page-stat strong { color: var(--text); }

        .divider {
            border: none;
            border-top: 1px solid var(--border);
            margin: 16px 0;
        }

        /* ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ */
        .navbar {
            display: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            z-index: 50;
            padding: 0;
        }
        .navbar.show { display: flex; }
        .nav-btn {
            flex: 1;
            padding: 12px 8px 14px;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-size: 0.72em;
            font-weight: 700;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: color 0.15s;
        }
        .nav-btn .nav-icon { font-size: 1.5em; line-height: 1; }
        .nav-btn.active { color: var(--accent); }
        .nav-btn:hover { color: var(--accent); }

        /* padding so content isn't hidden behind navbar */
        .has-navbar { padding-bottom: 72px; }

        /* ‚îÄ‚îÄ SMILEY SCREEN ‚îÄ‚îÄ */
        .smiley-row {
            display: flex;
            justify-content: space-around;
            margin: 24px 0;
        }
        .smiley-btn {
            font-size: 2.4em;
            background: none;
            border: 3px solid transparent;
            border-radius: 50%;
            width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            line-height: 1;
        }
        .smiley-btn:hover { transform: scale(1.15); }
        .smiley-btn.selected {
            border-color: var(--accent);
            background: var(--blue-bg);
            transform: scale(1.2);
        }

        /* ‚îÄ‚îÄ STATS SCREEN ‚îÄ‚îÄ */
        .tab-row {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
        }
        .tab-btn {
            flex: 1;
            padding: 8px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            background: var(--surface2);
            font-family: 'Nunito', sans-serif;
            font-size: 0.8em;
            font-weight: 700;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.15s;
        }
        .tab-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .metric-tabs {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .metric-tab {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1.5px solid var(--border);
            background: var(--surface2);
            font-family: 'Nunito', sans-serif;
            font-size: 0.8em;
            font-weight: 700;
            color: var(--muted);
            cursor: pointer;
            transition: all 0.15s;
        }
        .metric-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* SVG Chart */
        .chart-wrap {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px 8px 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        .chart-wrap svg { width: 100%; display: block; }

        .stats-empty {
            text-align: center;
            padding: 48px 20px;
            color: var(--muted);
            font-weight: 600;
        }
        .stats-empty .empty-icon { font-size: 3em; margin-bottom: 12px; }

        .session-history-item {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .session-history-item:last-child { border-bottom: none; }
        .session-date {
            font-size: 0.8em;
            font-weight: 700;
            color: var(--muted);
            min-width: 56px;
        }
        .session-pills {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            flex: 1;
        }
        .session-mood { font-size: 1.3em; margin-left: auto; }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .card { padding: 20px; }
            .btn { padding: 13px; }
            .countdown-number { font-size: 7em; }
        }
    </style>

</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     COUNTDOWN OVERLAY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
    <div class="countdown-label">Gleich geht's los!</div>
</div>

<div class="container">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 1: START
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screenStart">
    <div class="card" style="margin-top: 32px;">
        <div class="start-logo">
            <span style="font-size:4em;display:block;margin-bottom:8px;">üìñ</span>
        </div>
        <h1>Lesetrainer</h1>
        <p class="subtitle" style="margin-top:8px;" id="startSubtitle">Lesen √ºben & Fortschritte messen</p>
        
        <!-- Profile Selection -->
        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:0.8em; font-weight:700; color:var(--muted); 
                margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">
                Wer liest heute?
            </label>
            <select id="profileSelect" onchange="switchProfile()" 
                style="width:100%; padding:12px; border:1.5px solid var(--border); 
                border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; 
                font-size:1em; font-weight:600; background:var(--surface2); 
                color:var(--text); cursor:pointer;">
                <option value="">Profil w√§hlen...</option>
            </select>
            <button class="btn btn-ghost" onclick="showProfileManager()" 
                style="margin-top:8px; font-size:0.85em; padding:10px;">
                ‚öôÔ∏è Profile verwalten
            </button>
        </div>
        
        <button class="btn btn-primary" onclick="startSession()" id="startSessionBtn" disabled>
            ‚ñ∂ Los geht's!
        </button>
        
        <!-- Dev Tools (versteckt, nur f√ºr Tests) -->
        <details style="margin-top:20px; border-top:1px solid var(--border); padding-top:12px;">
            <summary style="cursor:pointer; color:var(--muted); font-size:0.8em; font-weight:700;">
                üõ†Ô∏è Entwickler-Tools
            </summary>
            <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
                <button class="btn btn-ghost" onclick="generateDummyData()" style="font-size:0.85em; padding:10px;">
                    üìä 20 Test-Sessions generieren
                </button>
                <button class="btn btn-ghost" onclick="clearAllData()" style="font-size:0.85em; padding:10px;">
                    üóëÔ∏è Alle Daten l√∂schen
                </button>
                <button class="btn btn-ghost" onclick="exportData()" style="font-size:0.85em; padding:10px;">
                    üíæ Daten exportieren (JSON)
                </button>
                <button class="btn btn-ghost" onclick="document.getElementById('importInput').click()" style="font-size:0.85em; padding:10px;">
                    üìÇ Daten importieren (JSON)
                </button>
                <input type="file" id="importInput" accept=".json,application/json" style="display:none" onchange="importData(event)">
            </div>
        </details>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 2: SEITE LESEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenPage">

    <div class="session-header">
        <span class="page-badge" id="pageBadge">Seite 1</span>
        <span style="font-size:0.85em; font-weight:700; color:var(--muted);" id="sessionWordCounter">0 W√∂rter</span>
        <span class="session-timer" id="sessionTimer">00:00</span>
    </div>

    <!-- Step A: Foto -->
    <div class="card" id="stepPhoto">
        <h2>Schritt 1 ‚Äî Text erfassen</h2>
        <div class="photo-buttons">
            <label class="photo-btn" for="cameraInput">
                <span class="btn-icon">üì∑</span>
                Kamera
            </label>
            <label class="photo-btn" for="galleryInput">
                <span class="btn-icon">üñºÔ∏è</span>
                Galerie
            </label>
        </div>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none">
        <input type="file" id="galleryInput" accept="image/*" style="display:none">

        <div id="ocrStatus"></div>
        <img id="previewImg" class="preview-img">

        <div class="section-label" style="margin-top:14px;">Referenztext</div>
        <textarea id="referenceText"
            placeholder="Text erscheint hier nach dem Foto... oder direkt eintippen"></textarea>
        <div class="word-count" id="wordCount">0 W√∂rter</div>

        <button class="btn btn-primary" id="toRecordBtn" onclick="goToRecord()" disabled style="margin-top:14px;">
            üé§ Aufnahme starten
        </button>
        <button class="btn btn-ghost" onclick="goToRecord()">
            Ohne Foto weitermachen
        </button>
    </div>

    <!-- Step B: Aufnehmen -->
    <div class="card" id="stepRecord" style="display:none">
        <h2>Schritt 2 ‚Äî Vorlesen</h2>

        <div class="recording-indicator" id="recIndicator">
            <div class="rec-dot"></div>
            <span class="rec-label">Aufnahme l√§uft</span>
            <span class="rec-timer" id="recTimer">00:00</span>
        </div>

        <div id="recordStatus"></div>

        <div style="display:flex; gap:10px; margin-top:8px;">
            <button class="btn btn-success" id="startRecBtn" onclick="startRecording()" style="flex:1">
                ‚ñ∂ Los lesen!
            </button>
            <button class="btn btn-danger" id="stopRecBtn" onclick="stopRecording()" style="flex:1; display:none">
                ‚ñ† Fertig
            </button>
        </div>

        <button class="btn btn-ghost" onclick="backToPhoto()" style="margin-top:8px">
            ‚Üê Zur√ºck
        </button>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 3: MINI FEEDBACK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenFeedback">

    <div class="session-header">
        <span class="page-badge" id="feedbackPageBadge">Seite 1</span>
        <span style="font-size:0.85em; font-weight:700; color:var(--muted);" id="feedbackWordCounter">0 W√∂rter</span>
        <span class="session-timer" id="feedbackTimer">00:00</span>
    </div>

    <div class="card">
        <h2 id="feedbackTitle">Seite 1 geschafft!</h2>

        <div class="mini-feedback">
            <div class="mini-metric">
                <div class="val" id="fbWpm">-</div>
                <div class="lbl">W√∂rter / Min</div>
            </div>
            <div class="mini-metric">
                <div class="val" id="fbAccuracy">-</div>
                <div class="lbl">Genauigkeit</div>
            </div>
        </div>

        <div id="fbMessage" class="status info"></div>

        <div id="fbErrorSummary" class="error-pills" style="display:none;"></div>

        <details id="fbDetails" style="margin-top:14px;">
            <summary>Wort-f√ºr-Wort Analyse</summary>
            <div id="fbWordView" class="word-view"></div>
            <div class="legend" style="margin-top:10px;">
                <span style="color:var(--green);">‚óè richtig</span>
                <span style="color:var(--red);">‚óè falsch</span>
                <span style="color:var(--muted);">‚óè ausgelassen</span>
                <span style="color:var(--blue);">‚óè hinzugef√ºgt</span>
            </div>
        </details>

        <hr class="divider" style="margin-top:16px;">

        <button class="btn btn-primary" onclick="nextPage()">
            ‚Üí N√§chste Seite
        </button>
        <button class="btn btn-ghost" onclick="retryPage()">
            ‚Ü∫ Nochmal lesen
        </button>
        <button class="btn btn-ghost" onclick="endSession()">
            ‚úì Session beenden
        </button>
    </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 4: SESSION SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenSummary">
    <div class="card">
        <div class="summary-hero">
            <div class="summary-emoji" id="summaryEmoji">üåü</div>
            <div class="summary-message" id="summaryMessage">Super gemacht!</div>
            <div class="summary-sub" id="summarySub"></div>
        </div>

        <div class="summary-stats">
            <div class="stat-box">
                <div class="val" id="sumPages">-</div>
                <div class="lbl">Seiten</div>
            </div>
            <div class="stat-box">
                <div class="val" id="sumDuration">-</div>
                <div class="lbl">Minuten</div>
            </div>
            <div class="stat-box">
                <div class="val" id="sumWpm">-</div>
                <div class="lbl">√ò W / Min</div>
            </div>
            <div class="stat-box">
                <div class="val" id="sumAccuracy">-</div>
                <div class="lbl">√ò Genauigkeit</div>
            </div>
        </div>

        <div class="pages-list">
            <h3>Pro Seite</h3>
            <div id="pagesList"></div>
        </div>

        <div class="pages-list" id="frequentErrorsSection" style="display:none; margin-top:16px;">
            <h3>H√§ufige Fehler</h3>
            <div id="frequentErrorsList"></div>
        </div>

        <button class="btn btn-primary" onclick="goToSmiley()" style="margin-top:20px">
            ‚Üí Weiter
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 5: SMILEY FEEDBACK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenSmiley">
    <div class="card" style="margin-top:32px;">
        <div style="text-align:center; margin-bottom:8px;">
            <span style="font-size:3em;">üéâ</span>
        </div>
        <h1 style="font-size:1.4em; margin-bottom:6px;">Wie war die Session?</h1>
        <p class="subtitle">JJ, wie hat dir das Lesen heute gefallen?</p>

        <div class="smiley-row">
            <button class="smiley-btn" onclick="selectSmiley(-2)" data-val="-2" title="Gar nicht">üòû</button>
            <button class="smiley-btn" onclick="selectSmiley(-1)" data-val="-1" title="Nicht so gut">üòï</button>
            <button class="smiley-btn" onclick="selectSmiley(0)"  data-val="0"  title="Ok">üòê</button>
            <button class="smiley-btn" onclick="selectSmiley(1)"  data-val="1"  title="Gut">üôÇ</button>
            <button class="smiley-btn" onclick="selectSmiley(2)"  data-val="2"  title="Super!">üòÑ</button>
        </div>

        <button class="btn btn-primary" id="smileyConfirmBtn" onclick="confirmSmiley()" disabled>
            Fertig!
        </button>
        <button class="btn btn-ghost" onclick="confirmSmiley(true)">
            √úberspringen
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 6: STATISTIK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenStats">
    <div style="padding-top: 8px;">

        <div class="card">
            <h2>Zeitraum</h2>
            <div class="tab-row">
                <button class="tab-btn active" onclick="setTimeRange('days')"   id="tabDays">Tage</button>
                <button class="tab-btn"        onclick="setTimeRange('weeks')"  id="tabWeeks">Wochen</button>
                <button class="tab-btn"        onclick="setTimeRange('months')" id="tabMonths">Monate</button>
            </div>

            <h2 style="margin-top:4px;">Metrik</h2>
            <div class="metric-tabs">
                <button class="metric-tab active" onclick="setMetric('wpm')"      id="mWpm">WPM</button>
                <button class="metric-tab"        onclick="setMetric('accuracy')" id="mAcc">Genauigkeit</button>
                <button class="metric-tab"        onclick="setMetric('mood')"     id="mMood">Stimmung</button>
                <button class="metric-tab"        onclick="setMetric('words')"    id="mWords">W√∂rter</button>
            </div>

            <div class="chart-wrap" id="chartWrap">
                <svg id="chart" height="160" viewBox="0 0 300 160" preserveAspectRatio="none"></svg>
            </div>

            <div id="statsEmpty" class="stats-empty" style="display:none;">
                <div class="empty-icon">üìä</div>
                Noch keine Daten f√ºr diesen Zeitraum
            </div>
        </div>

        <div class="card">
            <h2>Letzte Sessions</h2>
            <div id="sessionHistoryList">
                <div class="stats-empty">
                    <div class="empty-icon">üìö</div>
                    Noch keine Sessions gespeichert
                </div>
            </div>
        </div>

    </div>
</div>

</div><!-- /container -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 7: PROFILE MANAGER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenProfiles">
    <div class="card" style="margin-top:32px;">
        <h1 style="font-size:1.4em; margin-bottom:16px;">Profile verwalten</h1>
        
        <div id="profileList" style="margin-bottom:20px;"></div>
        
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
            <label style="display:block; font-size:0.8em; font-weight:700; color:var(--muted); 
                margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">
                Neues Profil
            </label>
            <div style="display:flex; gap:8px;">
                <input type="text" id="newProfileName" placeholder="Name eingeben..." 
                    style="flex:1; padding:12px; border:1.5px solid var(--border); 
                    border-radius:var(--radius-sm); font-family:'Nunito',sans-serif; 
                    font-size:0.95em; font-weight:600; background:var(--surface2);"
                    onkeypress="if(event.key==='Enter') addProfile()">
                <button class="btn btn-primary" onclick="addProfile()" style="margin:0;">
                    Hinzuf√ºgen
                </button>
            </div>
        </div>
        
        <button class="btn btn-ghost" onclick="closeProfileManager()" style="margin-top:16px;">
            ‚Üê Zur√ºck
        </button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     NAVBAR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="navbar" id="navbar">
    <button class="nav-btn active" id="navSession" onclick="navTo('session')">
        <span class="nav-icon">üìñ</span>
        Session
    </button>
    <button class="nav-btn" id="navStats" onclick="navTo('stats')">
        <span class="nav-icon">üìä</span>
        Statistik
    </button>
</nav>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
    currentPage: 1,
    sessionStartTime: null,
    sessionTimerInterval: null,
    recStartTime: null,
    recTimerInterval: null,
    mediaRecorder: null,
    audioChunks: [],
    referenceWords: [],
    pages: [], // {wpm, accuracy, duration, wordCount, errors, alignment}
    currentProfile: null,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PROFILES_KEY = 'lesetrainer_profiles';
const SESSIONS_KEY_PREFIX = 'lesetrainer_sessions_';

function loadProfiles() {
    try {
        const profiles = JSON.parse(localStorage.getItem(PROFILES_KEY) || '[]');
        // Ensure at least one default profile exists
        if (profiles.length === 0) {
            profiles.push({ id: 'default', name: 'JJ', createdAt: new Date().toISOString() });
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
        }
        return profiles;
    } catch { return [{ id: 'default', name: 'JJ', createdAt: new Date().toISOString() }]; }
}

function saveProfiles(profiles) {
    localStorage.setItem(PROFILES_KEY, JSON.stringify(profiles));
}

function getCurrentProfile() {
    if (!state.currentProfile) {
        const lastProfile = localStorage.getItem('lesetrainer_last_profile');
        if (lastProfile) {
            state.currentProfile = lastProfile;
        } else {
            const profiles = loadProfiles();
            state.currentProfile = profiles[0]?.id || null;
        }
    }
    return state.currentProfile;
}

function setCurrentProfile(profileId) {
    state.currentProfile = profileId;
    localStorage.setItem('lesetrainer_last_profile', profileId);
}

function getSessionsKey() {
    const profileId = getCurrentProfile();
    return profileId ? SESSIONS_KEY_PREFIX + profileId : STORAGE_KEY;
}

function switchProfile() {
    const select = document.getElementById('profileSelect');
    const profileId = select.value;
    if (!profileId) {
        document.getElementById('startSessionBtn').disabled = true;
        document.getElementById('startSubtitle').textContent = 'Lesen √ºben & Fortschritte messen';
        return;
    }
    setCurrentProfile(profileId);
    document.getElementById('startSessionBtn').disabled = false;
    
    // Personalized greeting
    const profileName = loadProfiles().find(p => p.id === profileId)?.name || '';
    if (profileName) {
        document.getElementById('startSubtitle').textContent = `Heute liest ${profileName}! üìñ`;
        // Update smiley screen text
        document.querySelector('#screenSmiley .subtitle').textContent = `${profileName}, wie hat dir das Lesen heute gefallen?`;
    }
    
    // Reload navbar visibility based on new profile's data
    const sessions = loadSessions();
    showNavbar(sessions.length > 0);
    
    // If on stats screen, rebuild it
    if (document.getElementById('screenStats').classList.contains('active')) {
        buildStatsScreen();
    }
}

function populateProfileSelect() {
    const profiles = loadProfiles();
    const select = document.getElementById('profileSelect');
    const currentProfile = getCurrentProfile();
    
    select.innerHTML = '<option value="">Profil w√§hlen...</option>' + 
        profiles.map(p => 
            `<option value="${p.id}" ${p.id === currentProfile ? 'selected' : ''}>${p.name}</option>`
        ).join('');
    
    document.getElementById('startSessionBtn').disabled = !currentProfile;

    // Set personalized greeting if a profile is already selected
    if (currentProfile) {
        const profileName = profiles.find(p => p.id === currentProfile)?.name || '';
        if (profileName) {
            document.getElementById('startSubtitle').textContent = `Heute liest ${profileName}! üìñ`;
            document.querySelector('#screenSmiley .subtitle').textContent = `${profileName}, wie hat dir das Lesen heute gefallen?`;
        }
    }
}

function showProfileManager() {
    buildProfileList();
    showScreen('screenProfiles');
}

function closeProfileManager() {
    showScreen('screenStart');
    populateProfileSelect();
}

function buildProfileList() {
    const profiles = loadProfiles();
    const list = document.getElementById('profileList');
    
    list.innerHTML = profiles.map(p => {
        const sessions = JSON.parse(localStorage.getItem(SESSIONS_KEY_PREFIX + p.id) || '[]');
        return `
            <div style="display:flex; align-items:center; padding:12px; background:var(--surface2); 
                border-radius:var(--radius-sm); margin-bottom:8px; border:1.5px solid var(--border);">
                <div style="flex:1;">
                    <div style="font-weight:700; color:var(--text);">${p.name}</div>
                    <div style="font-size:0.8em; color:var(--muted); margin-top:2px;">
                        ${sessions.length} Sessions
                    </div>
                </div>
                <button onclick="deleteProfile('${p.id}')" 
                    style="background:none; border:none; cursor:pointer; font-size:1.2em; 
                    color:var(--red); padding:8px;" 
                    title="Profil l√∂schen"
                    ${profiles.length === 1 ? 'disabled' : ''}>üóëÔ∏è</button>
            </div>`;
    }).join('');
}

function addProfile() {
    const input = document.getElementById('newProfileName');
    const name = input.value.trim();
    if (!name) return;
    
    const profiles = loadProfiles();
    const id = 'profile_' + Date.now();
    profiles.push({ id, name, createdAt: new Date().toISOString() });
    saveProfiles(profiles);
    
    input.value = '';
    buildProfileList();
    populateProfileSelect();
}

function deleteProfile(profileId) {
    const profiles = loadProfiles();
    if (profiles.length === 1) {
        alert('Das letzte Profil kann nicht gel√∂scht werden');
        return;
    }
    
    const profile = profiles.find(p => p.id === profileId);
    if (!confirm(`Profil "${profile.name}" wirklich l√∂schen? Alle Sessions gehen verloren!`)) return;
    
    // Delete profile and its sessions
    const newProfiles = profiles.filter(p => p.id !== profileId);
    saveProfiles(newProfiles);
    localStorage.removeItem(SESSIONS_KEY_PREFIX + profileId);
    
    // If deleting current profile, switch to first remaining
    if (getCurrentProfile() === profileId) {
        setCurrentProfile(newProfiles[0].id);
    }
    
    buildProfileList();
    populateProfileSelect();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREEN MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startSessionTimer() {
    state.sessionStartTime = Date.now();
    state.sessionTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - state.sessionStartTime) / 1000);
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        const display = `${m}:${s}`;
        document.getElementById('sessionTimer').textContent = display;
        document.getElementById('feedbackTimer').textContent = display;
    }, 1000);
}

function stopSessionTimer() {
    clearInterval(state.sessionTimerInterval);
}

function getSessionDurationMinutes() {
    return (Date.now() - state.sessionStartTime) / 60000;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECORDING TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startRecTimer() {
    state.recStartTime = Date.now();
    state.recTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - state.recStartTime) / 1000);
        const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const s = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('recTimer').textContent = `${m}:${s}`;
    }, 1000);
}

function stopRecTimer() {
    clearInterval(state.recTimerInterval);
}

function getRecDurationSeconds() {
    return (Date.now() - state.recStartTime) / 1000;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// START SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD PAGE SCREEN (reset for new page)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadPageScreen() {
    // Update badge
    document.getElementById('pageBadge').textContent = `Seite ${state.currentPage}`;

    // Reset photo step
    document.getElementById('stepPhoto').style.display = 'block';
    document.getElementById('stepRecord').style.display = 'none';

    // Reset textarea
    const ta = document.getElementById('referenceText');
    ta.value = '';
    ta.className = '';
    ta.style.borderColor = '';
    ta.style.background = '';
    document.getElementById('wordCount').textContent = '0 W√∂rter';

    // Reset photo preview
    document.getElementById('previewImg').style.display = 'none';
    document.getElementById('ocrStatus').innerHTML = '';

    // Reset record button
    document.getElementById('toRecordBtn').disabled = true;

    // Reset file inputs
    document.getElementById('cameraInput').value = '';
    document.getElementById('galleryInput').value = '';

    // Reset audio
    state.audioChunks = [];
    state.referenceWords = [];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEXT INPUT ‚Üí ENABLE RECORD BTN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('referenceText').addEventListener('input', function() {
    const words = this.value.trim().split(/\s+/).filter(w => w.length > 0);
    document.getElementById('wordCount').textContent = `${words.length} W√∂rter`;
    document.getElementById('toRecordBtn').disabled = words.length < 3;
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO / OCR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('cameraInput').addEventListener('change', e => handleImage(e.target.files[0]));
document.getElementById('galleryInput').addEventListener('change', e => handleImage(e.target.files[0]));

function compressImage(file, maxWidth = 1600, quality = 0.8) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            canvas.toBlob(resolve, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
    });
}

async function handleImage(file) {
    if (!file) return;

    // Preview
    const preview = document.getElementById('previewImg');
    preview.src = URL.createObjectURL(file);
    preview.style.display = 'block';

    showStatus('üîß Bild wird vorbereitet...', 'info', 'ocrStatus');

    try {
        const compressed = await compressImage(file);
        
        // Animated loading messages
        const ocrMessages = [
            'üìñ Ich lese das Buch...',
            'üîç Text wird erkannt...',
            '‚úçÔ∏è W√∂rter werden entziffert...',
        ];
        let msgIdx = 0;
        showStatus(ocrMessages[msgIdx], 'info', 'ocrStatus');
        const msgInterval = setInterval(() => {
            msgIdx = (msgIdx + 1) % ocrMessages.length;
            showStatus(ocrMessages[msgIdx], 'info', 'ocrStatus');
        }, 1200);

        const fd = new FormData();
        fd.append('image', compressed, 'image.jpg');

        const res = await fetch('/api/ocr', { method: 'POST', body: fd });
        clearInterval(msgInterval);
        if (!res.ok) {
            const err = await res.json();
            throw new Error(err.details || err.error || 'OCR fehlgeschlagen');
        }

        const data = await res.json();
        const text = data.text.trim();

        if (text) {
            const ta = document.getElementById('referenceText');
            ta.value = text;
            ta.classList.add('ocr-done');
            const words = text.split(/\s+/).filter(w => w.length > 0);
            document.getElementById('wordCount').textContent = `${words.length} W√∂rter`;
            document.getElementById('toRecordBtn').disabled = false;
            showStatus(`‚úÖ ${words.length} W√∂rter erkannt ‚Äì bei Bedarf korrigieren`, 'success', 'ocrStatus');
        } else {
            showStatus('‚ö†Ô∏è Kein Text gefunden. Bitte nochmal versuchen oder manuell eingeben.', 'warning', 'ocrStatus');
        }
    } catch (err) {
        clearInterval(msgInterval);
        showStatus('‚ùå ' + err.message, 'error', 'ocrStatus');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goToRecord() {
    const text = document.getElementById('referenceText').value.trim();
    if (!text) return;
    state.referenceWords = normalizeText(text).split(/\s+/).filter(w => w.length > 0);

    document.getElementById('stepPhoto').style.display = 'none';
    document.getElementById('stepRecord').style.display = 'block';

    // Reset record UI
    document.getElementById('startRecBtn').style.display = 'block';
    document.getElementById('stopRecBtn').style.display = 'none';
    document.getElementById('recIndicator').classList.remove('show');
    document.getElementById('recTimer').textContent = '00:00';
    document.getElementById('recordStatus').innerHTML = '';
}

function backToPhoto() {
    document.getElementById('stepRecord').style.display = 'none';
    document.getElementById('stepPhoto').style.display = 'block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WAKE LOCK (Bildschirm wach halten)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let wakeLock = null;

async function requestWakeLock() {
    // Keep screen on
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Wake Lock aktiviert');
        } catch (err) {
            console.warn('Wake Lock fehlgeschlagen:', err);
        }
    }
    // Lock screen orientation to portrait
    if (screen.orientation && screen.orientation.lock) {
        try {
            await screen.orientation.lock('portrait');
            console.log('Orientation auf Portrait gesperrt');
        } catch (err) {
            console.warn('Orientation Lock fehlgeschlagen:', err);
        }
    }
}

async function releaseWakeLock() {
    if (wakeLock) {
        try {
            await wakeLock.release();
            wakeLock = null;
            console.log('Wake Lock freigegeben');
        } catch (err) {
            console.warn('Wake Lock release fehlgeschlagen:', err);
        }
    }
    // Unlock orientation
    if (screen.orientation && screen.orientation.unlock) {
        try {
            screen.orientation.unlock();
        } catch (err) {
            console.warn('Orientation unlock fehlgeschlagen:', err);
        }
    }
}

// Re-acquire wake lock if page becomes visible again (e.g. after tab switch)
document.addEventListener('visibilitychange', async () => {
    if (wakeLock !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECORDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startRecording() {
    state.audioChunks = [];

    // Request wake lock FIRST before countdown (needs user gesture context)
    await requestWakeLock();

    // Countdown
    const overlay = document.getElementById('countdownOverlay');
    const num = document.getElementById('countdownNumber');
    overlay.classList.add('show');
    for (let i = 3; i > 0; i--) {
        num.textContent = i;
        await sleep(1000);
    }
    num.textContent = 'LOS!';
    await sleep(600);
    overlay.classList.remove('show');

    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });

        // Pick best supported audio format
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
            ? 'audio/webm;codecs=opus'
            : MediaRecorder.isTypeSupported('audio/webm')
            ? 'audio/webm'
            : 'audio/mp4';

        state.mediaRecorder = new MediaRecorder(stream, { mimeType });
        state.mediaRecorder.ondataavailable = e => { if (e.data.size > 0) state.audioChunks.push(e.data); };
        state.mediaRecorder.onstop = async () => {
            stream.getTracks().forEach(t => t.stop());
            await processRecording();
        };

        state.mediaRecorder.start(1000); // Collect data every second (more robust)
        startRecTimer();

        document.getElementById('startRecBtn').style.display = 'none';
        const stopBtn = document.getElementById('stopRecBtn');
        stopBtn.style.display = 'block';
        stopBtn.disabled = true;
        stopBtn.textContent = '‚ñ† Bitte warten...';
        document.getElementById('recIndicator').classList.add('show');
        showStatus('üé§ Aufnahme l√§uft ‚Äì jetzt vorlesen!', 'success', 'recordStatus');

        // Enable stop button after 3 seconds minimum
        setTimeout(() => {
            stopBtn.disabled = false;
            stopBtn.textContent = '‚ñ† Fertig';
        }, 3000);

    } catch (err) {
        releaseWakeLock();
        showStatus('‚ùå Mikrofon-Zugriff fehlgeschlagen: ' + err.message, 'error', 'recordStatus');
    }
}

function stopRecording() {
    if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
        state.mediaRecorder.stop();
        stopRecTimer();
        releaseWakeLock();

        const stopBtn = document.getElementById('stopRecBtn');
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = '‚ñ† Fertig';
        document.getElementById('recIndicator').classList.remove('show');
        showStatus('‚è≥ Wird ausgewertet...', 'info', 'recordStatus');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RETRY PAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function retryPage() {
    // Remove last page result (we're redoing it)
    if (state.pages.length > 0 && state.pages[state.pages.length - 1].page === state.currentPage) {
        state.pages.pop();
    }
    // Go back to recording step (keep the text/photo)
    showScreen('screenPage');
    document.getElementById('stepPhoto').style.display = 'none';
    document.getElementById('stepRecord').style.display = 'block';
    document.getElementById('startRecBtn').style.display = 'block';
    const stopBtn = document.getElementById('stopRecBtn');
    stopBtn.style.display = 'none';
    stopBtn.disabled = false;
    stopBtn.textContent = '‚ñ† Fertig';
    document.getElementById('recIndicator').classList.remove('show');
    document.getElementById('recTimer').textContent = '00:00';
    document.getElementById('recordStatus').innerHTML = '';
    state.audioChunks = [];
}

async function processRecording() {
    const durationSeconds = getRecDurationSeconds();

    // Check if we have audio data
    if (state.audioChunks.length === 0) {
        showStatus('‚ö†Ô∏è Keine Aufnahme gefunden. Bitte nochmal versuchen.', 'warning', 'recordStatus');
        document.getElementById('startRecBtn').style.display = 'block';
        return;
    }

    const blob = new Blob(state.audioChunks, { type: state.mediaRecorder?.mimeType || 'audio/webm' });
    
    // Check minimum size (corrupt/empty files are usually < 1KB)
    if (blob.size < 1000) {
        showStatus('‚ö†Ô∏è Aufnahme zu kurz oder leer. Bitte nochmal versuchen.', 'warning', 'recordStatus');
        document.getElementById('startRecBtn').style.display = 'block';
        return;
    }

    console.log('Audio blob size:', blob.size, 'bytes, duration:', durationSeconds, 's');

    try {
        const fd = new FormData();
        fd.append('audio', blob, 'recording.webm');

        showStatus('‚è≥ Wird ausgewertet...', 'info', 'recordStatus');

        const res = await fetch('/api/transcribe', { method: 'POST', body: fd });
        
        if (!res.ok) {
            // Try to parse error as JSON, fallback to status text
            let errMsg = `Server Fehler (${res.status})`;
            try {
                const errData = await res.json();
                errMsg = errData.error || errData.message || errMsg;
            } catch {
                const errText = await res.text();
                errMsg = errText.substring(0, 100) || errMsg;
            }
            throw new Error(errMsg);
        }

        const data = await res.json();
        const rawTranscript = data.text.trim();
        const wordTimings = data.words || [];  // [{word, start, end}, ...]
        const recognized = normalizeText(rawTranscript).split(/\s+/).filter(w => w.length > 0);

        const wpm = Math.round(recognized.length / (durationSeconds / 60));
        
        // Full alignment analysis
        const alignment = alignWords(state.referenceWords, recognized);
        const accuracy = calculateAccuracyFromAlignment(alignment, state.referenceWords.length);

        // Save page result with full error data
        state.pages.push({
            page: state.currentPage,
            wpm,
            accuracy,
            duration: Math.round(durationSeconds),
            wordCount: state.referenceWords.length,
            alignment,
            rawTranscript,
            wordTimings,   // [{word, start, end}] from Whisper verbose_json
            referenceText: state.referenceWords.join(' '),  // normalized reference
        });

        // Update live word counter
        const totalWords = state.pages.reduce((s, p) => s + (p.wordCount || 0), 0);
        const counterText = `${totalWords} W√∂rter`;
        document.getElementById('sessionWordCounter').textContent = counterText;
        document.getElementById('feedbackWordCounter').textContent = counterText;

        showFeedback(wpm, accuracy, alignment);

    } catch (err) {
        console.error('Processing error:', err);
        showStatus('‚ùå ' + err.message + ' ‚Äì Nochmal versuchen?', 'error', 'recordStatus');
        document.getElementById('startRecBtn').style.display = 'block';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MINI FEEDBACK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showFeedback(wpm, accuracy, alignment) {
    document.getElementById('feedbackPageBadge').textContent = `Seite ${state.currentPage}`;
    document.getElementById('feedbackTitle').textContent = `Seite ${state.currentPage} geschafft!`;
    document.getElementById('fbWpm').textContent = wpm;
    document.getElementById('fbAccuracy').textContent = accuracy + '%';

    // Count error types
    const substitutions = alignment.filter(a => a.type === 'substitution').length;
    const omissions     = alignment.filter(a => a.type === 'omission').length;
    const additions     = alignment.filter(a => a.type === 'addition').length;
    const correct       = alignment.filter(a => a.type === 'correct').length;
    const totalErrors   = substitutions + omissions;

    // Motivational message
    const profileName = loadProfiles().find(p => p.id === getCurrentProfile())?.name || '';
    const namePrefix = profileName ? `${profileName}, ` : '';
    let msg = '';
    if (accuracy >= 95) msg = `${namePrefix}fantastisch! Fast fehlerfrei!`;
    else if (accuracy >= 85) msg = `${namePrefix}sehr gut! Weiter so!`;
    else if (accuracy >= 70) msg = `Gut gemacht${profileName ? ', ' + profileName : ''}! √úb weiter!`;
    else msg = 'Weiterlesen macht besser!';
    if (wpm > 150) msg += ' Super schnell!';

    document.getElementById('fbMessage').textContent = msg;
    document.getElementById('fbMessage').className = 'status ' + (accuracy >= 85 ? 'success' : 'info');

    // Error pills
    const errSummary = document.getElementById('fbErrorSummary');
    if (correct > 0 || totalErrors > 0 || additions > 0) {
        const pills = [];
        if (correct > 0)       pills.push(`<span class="pill pill-green">${correct} richtig</span>`);
        if (substitutions > 0) pills.push(`<span class="pill pill-red">${substitutions} falsch</span>`);
        if (omissions > 0)     pills.push(`<span class="pill pill-grey">${omissions} ausgelassen</span>`);
        if (additions > 0)     pills.push(`<span class="pill pill-blue">${additions} hinzugef√ºgt</span>`);
        errSummary.innerHTML = pills.join('');
        errSummary.style.display = 'flex';
    } else {
        errSummary.style.display = 'none';
    }

    // Word-by-word view with new CSS classes
    const wordView = document.getElementById('fbWordView');
    wordView.innerHTML = alignment.map(a => {
        switch(a.type) {
            case 'correct':
                return `<span class="word-correct">${a.ref}</span>`;
            case 'substitution':
                return `<span class="word-wrong" title="gesagt: ${a.rec}"><s>${a.ref}</s>‚Üí${a.rec}</span>`;
            case 'omission':
                return `<span class="word-omitted">[${a.ref}]</span>`;
            case 'addition':
                return `<span class="word-added">+${a.rec}</span>`;
            default: return '';
        }
    }).join(' ');

    showScreen('screenFeedback');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORD ALIGNMENT (Needleman-Wunsch)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Returns array of {type, ref, rec} for each word
// types: 'correct' | 'substitution' | 'omission' | 'addition'
function alignWords(reference, recognized) {
    const m = reference.length;
    const n = recognized.length;

    // Limit length for performance
    const ref = reference.slice(0, Math.min(m, 300));
    const rec = recognized.slice(0, Math.min(n, 300));

    // Build DP table
    const GAP = -1;
    const MATCH = 2;
    const MISMATCH = -1;

    const dp = Array.from({length: ref.length + 1}, (_, i) =>
        Array.from({length: rec.length + 1}, (_, j) => {
            if (i === 0) return j * GAP;
            if (j === 0) return i * GAP;
            return 0;
        })
    );

    for (let i = 1; i <= ref.length; i++) {
        for (let j = 1; j <= rec.length; j++) {
            const score = ref[i-1] === rec[j-1] ? MATCH : MISMATCH;
            dp[i][j] = Math.max(
                dp[i-1][j-1] + score,  // match/mismatch
                dp[i-1][j] + GAP,       // omission (ref word skipped)
                dp[i][j-1] + GAP        // addition (extra word spoken)
            );
        }
    }

    // Traceback
    const result = [];
    let i = ref.length, j = rec.length;

    while (i > 0 || j > 0) {
        if (i > 0 && j > 0) {
            const score = ref[i-1] === rec[j-1] ? MATCH : MISMATCH;
            if (dp[i][j] === dp[i-1][j-1] + score) {
                result.unshift({
                    type: ref[i-1] === rec[j-1] ? 'correct' : 'substitution',
                    ref: ref[i-1],
                    rec: rec[j-1]
                });
                i--; j--;
                continue;
            }
        }
        if (i > 0 && dp[i][j] === dp[i-1][j] + GAP) {
            result.unshift({ type: 'omission', ref: ref[i-1], rec: null });
            i--;
        } else {
            result.unshift({ type: 'addition', ref: null, rec: rec[j-1] });
            j--;
        }
    }

    return result;
}

function calculateAccuracyFromAlignment(alignment, refLength) {
    if (refLength === 0) return 0;
    const correct = alignment.filter(a => a.type === 'correct').length;
    return Math.round((correct / refLength) * 100);
}

function calculateAccuracy(reference, recognized) {
    const alignment = alignWords(reference, recognized);
    return calculateAccuracyFromAlignment(alignment, reference.length);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEXT PAGE / END SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function nextPage() {
    state.currentPage++;
    loadPageScreen();
    showScreen('screenPage');
}

function endSession() {
    stopSessionTimer();
    buildSummary();
    showScreen('screenSummary');
}

function startSession() {
    state.currentPage = 1;
    state.pages = [];
    startSessionTimer();
    loadPageScreen();
    // Reset word counter
    document.getElementById('sessionWordCounter').textContent = '0 W√∂rter';
    document.getElementById('feedbackWordCounter').textContent = '0 W√∂rter';
    showScreen('screenPage');
    showNavbar(false); // Hide navbar during active session
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION SUMMARY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSummary() {
    const pages = state.pages;
    if (pages.length === 0) return;

    const totalDurationMin = getSessionDurationMinutes();
    const avgWpm = Math.round(pages.reduce((s, p) => s + p.wpm, 0) / pages.length);
    const avgAccuracy = Math.round(pages.reduce((s, p) => s + p.accuracy, 0) / pages.length);

    // Emoji & message based on performance
    const profileName = loadProfiles().find(p => p.id === getCurrentProfile())?.name || '';
    const nameSuffix = profileName ? `, ${profileName}` : '';
    let emoji, message, sub;
    if (avgAccuracy >= 95 && avgWpm >= 100) {
        emoji = 'üèÜ'; message = `Unglaublich gut${nameSuffix}!`;
        sub = 'Ein wirklich beeindruckendes Ergebnis!';
    } else if (avgAccuracy >= 85) {
        emoji = '‚≠ê'; message = `Super gemacht${nameSuffix}!`;
        sub = 'Du wirst von Mal zu Mal besser!';
    } else if (avgAccuracy >= 70) {
        emoji = 'üí™'; message = `Gut gelesen${nameSuffix}!`;
        sub = 'Mit jedem √úben wird es leichter!';
    } else {
        emoji = 'üìñ'; message = 'Weiter √ºben!';
        sub = 'Regelm√§√üiges Lesen macht den Unterschied!';
    }

    document.getElementById('summaryEmoji').textContent = emoji;
    document.getElementById('summaryMessage').textContent = message;
    document.getElementById('summarySub').textContent = sub;

    document.getElementById('sumPages').textContent = pages.length;
    document.getElementById('sumDuration').textContent = Math.round(totalDurationMin);
    document.getElementById('sumWpm').textContent = avgWpm;
    document.getElementById('sumAccuracy').textContent = avgAccuracy + '%';

    // Pages list with error counts
    const list = document.getElementById('pagesList');
    list.innerHTML = pages.map(p => {
        const subs = p.alignment ? p.alignment.filter(a => a.type === 'substitution').length : 0;
        const omis = p.alignment ? p.alignment.filter(a => a.type === 'omission').length : 0;
        const errorStr = (subs + omis) > 0
            ? `<span style="color:#dc3545; font-size:0.85em;">
                ${subs > 0 ? `üî¥${subs}` : ''} ${omis > 0 ? `‚ö´${omis}` : ''}
               </span>`
            : `<span style="color:#28a745; font-size:0.85em;">‚úÖ</span>`;
        return `
            <div class="page-row">
                <div class="page-num">${p.page}</div>
                <div class="page-stats">
                    <div class="page-stat">‚ö° <strong>${p.wpm}</strong> W/min</div>
                    <div class="page-stat">üéØ <strong>${p.accuracy}%</strong></div>
                    <div class="page-stat">${errorStr}</div>
                </div>
            </div>`;
    }).join('');

    // Collect all errors across pages
    const allErrors = {};
    pages.forEach(p => {
        if (!p.alignment) return;
        p.alignment
            .filter(a => a.type === 'substitution' || a.type === 'omission')
            .forEach(a => {
                const word = a.ref;
                allErrors[word] = (allErrors[word] || 0) + 1;
            });
    });

    const topErrors = Object.entries(allErrors)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    const errSection = document.getElementById('frequentErrorsSection');
    const errList = document.getElementById('frequentErrorsList');

    if (topErrors.length > 0) {
        errList.innerHTML = topErrors.map(([word, count]) =>
            `<div class="page-row">
                <div style="flex:1; font-weight:600; color:var(--text2);">${word}</div>
                <div style="color:#dc3545; font-size:0.9em;">${count}√ó Fehler</div>
            </div>`
        ).join('');
        errSection.style.display = 'block';
    } else {
        errSection.style.display = 'none';
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NEW SESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function newSession() {
    showScreen('screenStart');
    showNavbar(true);
    setNavActive('session');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNavbar(show) {
    document.getElementById('navbar').classList.toggle('show', show);
    document.querySelectorAll('.screen').forEach(s => {
        if (show) s.classList.add('has-navbar');
        else s.classList.remove('has-navbar');
    });
}

function setNavActive(tab) {
    document.getElementById('navSession').classList.toggle('active', tab === 'session');
    document.getElementById('navStats').classList.toggle('active', tab === 'stats');
}

function navTo(tab) {
    setNavActive(tab);
    if (tab === 'stats') {
        buildStatsScreen();
        showScreen('screenStats');
    } else {
        showScreen('screenStart');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOCALSTORAGE (now profile-aware)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY = 'lesetrainer_sessions'; // Legacy key

function loadSessions() {
    try {
        const key = getSessionsKey();
        return JSON.parse(localStorage.getItem(key) || '[]');
    } catch { return []; }
}

function saveSession(sessionData) {
    const sessions = loadSessions();
    sessions.push(sessionData);
    const key = getSessionsKey();
    localStorage.setItem(key, JSON.stringify(sessions));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SMILEY SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedMood = null;
let pendingSessionData = null;

function goToSmiley() {
    // Build session data to save after mood is collected
    const pages = state.pages;
    const totalDurationMin = getSessionDurationMinutes();
    const avgWpm      = Math.round(pages.reduce((s, p) => s + p.wpm, 0) / pages.length);
    const avgAccuracy = Math.round(pages.reduce((s, p) => s + p.accuracy, 0) / pages.length);
    const totalWords  = pages.reduce((s, p) => s + (p.wordCount || 0), 0);

    // Collect frequent errors across pages
    const errorCounts = {};
    pages.forEach(p => {
        if (!p.alignment) return;
        p.alignment
            .filter(a => a.type === 'substitution' || a.type === 'omission')
            .forEach(a => { errorCounts[a.ref] = (errorCounts[a.ref] || 0) + 1; });
    });
    const topErrors = Object.entries(errorCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([word, count]) => ({ word, count }));

    pendingSessionData = {
        id: Date.now(),
        date: new Date().toISOString(),
        durationMin: Math.round(totalDurationMin),
        pageCount: pages.length,
        avgWpm,
        avgAccuracy,
        totalWords,
        topErrors,
        mood: null,
        // Vollst√§ndige Seiten-Details f√ºr Lesefluss-Analyse:
        pageDetails: pages.map(p => ({
            page: p.page,
            wpm: p.wpm,
            accuracy: p.accuracy,
            duration: p.duration,
            wordCount: p.wordCount,
            referenceText: p.referenceText || '',
            rawTranscript: p.rawTranscript || '',
            alignment: p.alignment || [],
            wordTimings: p.wordTimings || [],
        })),
    };

    // Reset smiley UI
    selectedMood = null;
    document.querySelectorAll('.smiley-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('smileyConfirmBtn').disabled = true;
    showScreen('screenSmiley');
}

function selectSmiley(val) {
    selectedMood = val;
    document.querySelectorAll('.smiley-btn').forEach(b => {
        b.classList.toggle('selected', parseInt(b.dataset.val) === val);
    });
    document.getElementById('smileyConfirmBtn').disabled = false;
}

function confirmSmiley(skip = false) {
    if (pendingSessionData) {
        pendingSessionData.mood = skip ? null : selectedMood;
        saveSession(pendingSessionData);
        pendingSessionData = null;
    }
    // Show navbar now that we have data
    showNavbar(true);
    setNavActive('session');
    showScreen('screenStart');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let statsTimeRange = 'days';
let statsMetric    = 'wpm';

function setTimeRange(range) {
    statsTimeRange = range;
    ['Days','Weeks','Months'].forEach(r => {
        document.getElementById('tab' + r).classList.toggle('active', range === r.toLowerCase());
    });
    buildStatsScreen();
}

function setMetric(metric) {
    statsMetric = metric;
    ['wpm','accuracy','mood','words'].forEach(m => {
        const map = { wpm:'mWpm', accuracy:'mAcc', mood:'mMood', words:'mWords' };
        document.getElementById(map[m]).classList.toggle('active', metric === m);
    });
    buildStatsScreen();
}

function buildStatsScreen() {
    const sessions = loadSessions();
    buildSessionHistory(sessions);
    buildChart(sessions);
}

function buildSessionHistory(sessions) {
    const list = document.getElementById('sessionHistoryList');
    if (sessions.length === 0) {
        list.innerHTML = `<div class="stats-empty"><div class="empty-icon">üìö</div>Noch keine Sessions gespeichert</div>`;
        return;
    }
    const moodEmoji = { '-2':'üòû', '-1':'üòï', '0':'üòê', '1':'üôÇ', '2':'üòÑ' };
    list.innerHTML = [...sessions].reverse().slice(0, 20).map((s, idx) => {
        const originalIdx = sessions.length - 1 - idx; // Actual index in array
        const d = new Date(s.date);
        const dateStr = d.toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit' });
        const timeStr = d.toLocaleTimeString('de-DE', { hour:'2-digit', minute:'2-digit' });
        const mood = s.mood != null ? (moodEmoji[String(s.mood)] || '') : '';
        return `
            <div class="session-history-item">
                <div class="session-date">${dateStr}<br><span style="font-size:0.85em;">${timeStr}</span></div>
                <div class="session-pills">
                    <span class="pill pill-blue">${s.avgWpm} WPM</span>
                    <span class="pill pill-green">${s.avgAccuracy}%</span>
                    <span class="pill pill-grey">${s.pageCount ?? s.pages} S.</span>
                    <span class="pill pill-grey">${s.durationMin} min</span>
                </div>
                ${mood ? `<div class="session-mood">${mood}</div>` : ''}
                <button onclick="deleteSession(${originalIdx})" 
                    style="margin-left:4px; background:none; border:none; cursor:pointer; 
                    font-size:1.1em; color:var(--red); padding:4px;" 
                    title="Session l√∂schen">üóëÔ∏è</button>
            </div>`;
    }).join('');
}

function buildChart(sessions) {
    const chartEl  = document.getElementById('chart');
    const chartWrap = document.getElementById('chartWrap');
    const emptyEl  = document.getElementById('statsEmpty');

    if (sessions.length === 0) {
        chartWrap.style.display = 'none';
        emptyEl.style.display   = 'block';
        return;
    }

    // Group sessions by time range
    const groups = groupSessions(sessions, statsTimeRange);
    const labels = Object.keys(groups);
    const values = labels.map(l => {
        const s = groups[l];
        if (s.length === 0) return null;
        switch (statsMetric) {
            case 'wpm':      return Math.round(s.reduce((a,x) => a + x.avgWpm, 0) / s.length);
            case 'accuracy': return Math.round(s.reduce((a,x) => a + x.avgAccuracy, 0) / s.length);
            case 'mood':     {
                const withMood = s.filter(x => x.mood != null);
                return withMood.length ? +(s.reduce((a,x) => a + (x.mood||0), 0) / withMood.length).toFixed(1) : null;
            }
            case 'words':    return s.reduce((a,x) => a + x.totalWords, 0);
        }
    });

    const nonNull = values.filter(v => v !== null);
    if (nonNull.length === 0) {
        chartWrap.style.display = 'none';
        emptyEl.style.display   = 'block';
        return;
    }

    chartWrap.style.display = 'block';
    emptyEl.style.display   = 'none';

    const W = 300, H = 160, PAD = { t:16, r:16, b:28, l:40 };
    const cW = W - PAD.l - PAD.r;
    const cH = H - PAD.t - PAD.b;

    const minV = Math.min(...nonNull);
    const maxV = Math.max(...nonNull);
    const range = maxV - minV || 1;

    const n = labels.length;
    const step = cW / Math.max(n - 1, 1);

    const toX = i => PAD.l + i * step;
    const toY = v => v == null ? null : PAD.t + cH - ((v - minV) / range) * cH;

    // Build SVG
    let svg = '';

    // Grid lines
    for (let i = 0; i <= 4; i++) {
        const y = PAD.t + (cH / 4) * i;
        const val = Math.round(maxV - (range / 4) * i);
        svg += `<line x1="${PAD.l}" y1="${y}" x2="${W - PAD.r}" y2="${y}"
            stroke="#e2e8f0" stroke-width="1"/>`;
        svg += `<text x="${PAD.l - 6}" y="${y + 4}" text-anchor="end"
            font-size="9" fill="#94a3b8" font-family="Nunito">${val}</text>`;
    }

    // Area fill
    const pts = values.map((v, i) => v != null ? `${toX(i)},${toY(v)}` : null).filter(Boolean);
    if (pts.length >= 2) {
        const first = pts[0].split(',');
        const last  = pts[pts.length - 1].split(',');
        const area  = `M${first[0]},${H - PAD.b} L${pts.join(' L')} L${last[0]},${H - PAD.b} Z`;
        svg += `<path d="${area}" fill="#3b7df8" opacity="0.1"/>`;

        // Line
        svg += `<polyline points="${pts.join(' ')}" fill="none"
            stroke="#3b7df8" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>`;
    }

    // Dots + labels
    values.forEach((v, i) => {
        if (v == null) return;
        const x = toX(i), y = toY(v);
        svg += `<circle cx="${x}" cy="${y}" r="4" fill="#3b7df8"/>`;
        svg += `<text x="${x}" y="${y - 8}" text-anchor="middle"
            font-size="9" fill="#475569" font-weight="700" font-family="Nunito">${v}</text>`;
    });

    // X labels
    const maxLabels = Math.min(n, 7);
    const labelStep = Math.max(1, Math.floor(n / maxLabels));
    labels.forEach((lbl, i) => {
        if (i % labelStep !== 0 && i !== n - 1) return;
        svg += `<text x="${toX(i)}" y="${H - PAD.b + 14}" text-anchor="middle"
            font-size="9" fill="#94a3b8" font-family="Nunito">${lbl}</text>`;
    });

    chartEl.setAttribute('viewBox', `0 0 ${W} ${H}`);
    chartEl.innerHTML = svg;
}

function groupSessions(sessions, range) {
    const groups = {};
    const now = new Date();

    sessions.forEach(s => {
        const d = new Date(s.date);
        let key;
        if (range === 'days') {
            // Last 14 days
            const diffDays = Math.floor((now - d) / 86400000);
            if (diffDays > 14) return;
            key = d.toLocaleDateString('de-DE', { day:'2-digit', month:'2-digit' });
        } else if (range === 'weeks') {
            // ISO week
            const jan1 = new Date(d.getFullYear(), 0, 1);
            const week = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
            key = `KW${week}`;
        } else {
            key = d.toLocaleDateString('de-DE', { month:'short', year:'2-digit' });
        }
        if (!groups[key]) groups[key] = [];
        groups[key].push(s);
    });

    return groups;
}

// Show navbar on start screen if sessions exist
(function() {
    populateProfileSelect();
    const sessions = loadSessions();
    if (sessions.length > 0) showNavbar(true);
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEV TOOLS & SESSION MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateDummyData() {
    const profileName = loadProfiles().find(p => p.id === getCurrentProfile())?.name || 'Unbekannt';
    if (!confirm(`20 Test-Sessions f√ºr "${profileName}" generieren?`)) return;
    
    const now = Date.now();
    const sessions = [];
    
    for (let i = 0; i < 20; i++) {
        // Spread over last 30 days
        const daysAgo = Math.floor(Math.random() * 30);
        const date = new Date(now - daysAgo * 24 * 60 * 60 * 1000);
        date.setHours(Math.floor(Math.random() * 12) + 8); // 8-20 Uhr
        date.setMinutes(Math.floor(Math.random() * 60));
        
        // Realistic progression: improve over time (older = lower WPM)
        const baseWpm = 25 + (30 - daysAgo) * 0.8; // Start at 25, improve to ~50
        const wpm = Math.round(baseWpm + (Math.random() * 10 - 5));
        
        const baseAcc = 75 + (30 - daysAgo) * 0.5; // Start at 75%, improve to ~90%
        const accuracy = Math.round(Math.min(98, baseAcc + (Math.random() * 10 - 5)));
        
        sessions.push({
            id: date.getTime() + i,
            date: date.toISOString(),
            durationMin: Math.floor(Math.random() * 8) + 3, // 3-10 min
            pages: Math.floor(Math.random() * 4) + 1,       // 1-4 pages
            avgWpm: wpm,
            avgAccuracy: accuracy,
            totalWords: Math.floor(wpm * (Math.random() * 5 + 3)), // ~words read
            topErrors: [
                { word: 'und', count: Math.floor(Math.random() * 3) + 1 },
                { word: 'der', count: Math.floor(Math.random() * 2) + 1 },
            ],
            mood: Math.floor(Math.random() * 5) - 2, // -2 to 2
        });
    }
    
    // Sort by date
    sessions.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const key = getSessionsKey();
    localStorage.setItem(key, JSON.stringify(sessions));
    showNavbar(true);
    alert('‚úÖ 20 Test-Sessions erstellt!');
    if (document.getElementById('screenStats').classList.contains('active')) {
        buildStatsScreen();
    }
}

function deleteSession(index) {
    if (!confirm('Diese Session wirklich l√∂schen?')) return;
    const sessions = loadSessions();
    sessions.splice(index, 1);
    const key = getSessionsKey();
    localStorage.setItem(key, JSON.stringify(sessions));
    buildStatsScreen();
    if (sessions.length === 0) showNavbar(false);
}

function clearAllData() {
    const profileName = loadProfiles().find(p => p.id === getCurrentProfile())?.name || 'Unbekannt';
    if (!confirm(`ALLE Sessions von "${profileName}" l√∂schen? Das kann nicht r√ºckg√§ngig gemacht werden!`)) return;
    const key = getSessionsKey();
    localStorage.removeItem(key);
    showNavbar(false);
    alert('‚úÖ Alle Daten gel√∂scht');
    if (document.getElementById('screenStats').classList.contains('active')) {
        buildStatsScreen();
    }
}

function exportData() {
    const sessions = loadSessions();
    if (sessions.length === 0) {
        alert('Keine Daten zum Exportieren vorhanden');
        return;
    }
    const json = JSON.stringify(sessions, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lesetrainer-export-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) throw new Error('Ung√ºltiges Format ‚Äì Array erwartet');
            
            const profileName = loadProfiles().find(p => p.id === getCurrentProfile())?.name || 'Unbekannt';
            const existing = loadSessions();
            
            // Merge: avoid duplicates by id
            const existingIds = new Set(existing.map(s => s.id));
            const newSessions = imported.filter(s => !existingIds.has(s.id));
            const merged = [...existing, ...newSessions].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const key = getSessionsKey();
            localStorage.setItem(key, JSON.stringify(merged));
            
            // Reset file input
            event.target.value = '';
            
            showNavbar(merged.length > 0);
            alert(`‚úÖ Import abgeschlossen!\n${newSessions.length} neue Sessions hinzugef√ºgt (${imported.length - newSessions.length} Duplikate √ºbersprungen)\nGesamt: ${merged.length} Sessions f√ºr "${profileName}"`);
            
            if (document.getElementById('screenStats').classList.contains('active')) {
                buildStatsScreen();
            }
        } catch (err) {
            alert('‚ùå Import fehlgeschlagen: ' + err.message);
            event.target.value = '';
        }
    };
    reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ZAHLEN-NORMALISIERUNG ‚îÄ‚îÄ
// Wandelt Ziffern in deutsche W√∂rter um, damit "2" und "zwei" als gleich gelten
const ZAHLEN_MAP = {
    '0': 'null', '1': 'ein', '2': 'zwei', '3': 'drei', '4': 'vier',
    '5': 'f√ºnf', '6': 'sechs', '7': 'sieben', '8': 'acht', '9': 'neun',
    '10': 'zehn', '11': 'elf', '12': 'zw√∂lf', '13': 'dreizehn',
    '14': 'vierzehn', '15': 'f√ºnfzehn', '16': 'sechzehn', '17': 'siebzehn',
    '18': 'achtzehn', '19': 'neunzehn', '20': 'zwanzig', '30': 'drei√üig',
    '40': 'vierzig', '50': 'f√ºnfzig', '60': 'sechzig', '70': 'siebzig',
    '80': 'achtzig', '90': 'neunzig', '100': 'hundert', '1000': 'tausend'
};

const ORDINAL_MAP = {
    '1': 'erste', '2': 'zweite', '3': 'dritte', '4': 'vierte', '5': 'f√ºnfte',
    '6': 'sechste', '7': 'siebte', '8': 'achte', '9': 'neunte', '10': 'zehnte',
    '11': 'elfte', '12': 'zw√∂lfte', '13': 'dreizehnte', '14': 'vierzehnte',
    '15': 'f√ºnfzehnte', '16': 'sechzehnte', '17': 'siebzehnte', '18': 'achtzehnte',
    '19': 'neunzehnte', '20': 'zwanzigste'
};

function normalizeNumbers(text) {
    // Ordinalzahlen zuerst: "1." ‚Üí "erste" (nur wenn gefolgt von Leerzeichen oder Satzende)
    text = text.replace(/\b(\d+)\.\s/g, (match, num) => {
        return (ORDINAL_MAP[num] || num + '.') + ' ';
    });
    // Dann Kardinalzahlen: "2" ‚Üí "zwei"
    return text.replace(/\b(\d+)\b/g, (match) => {
        return ZAHLEN_MAP[match] || match;
    });
}

function normalizeText(text) {
    return normalizeNumbers(text)
        .toLowerCase()
        // Normalize German umlauts (in case of encoding differences)
        .replace(/√§/g, '√§').replace(/√∂/g, '√∂').replace(/√º/g, '√º')
        .replace(/√Ñ/g, '√§').replace(/√ñ/g, '√∂').replace(/√ú/g, '√º')
        .replace(/√ü/g, 'ss')
        // Remove all punctuation and special characters
        .replace(/[.,\/#!$%\^&\*;:{}=_`~()?"'¬ª¬´‚Äû"\-‚Äì‚Äî]/g, ' ')
        // Remove line breaks and tabs (treat as spaces)
        .replace(/[\r\n\t]/g, ' ')
        // Normalize multiple spaces
        .replace(/\s+/g, ' ')
        .trim();
}

function showStatus(msg, type, elementId) {
    const el = document.getElementById(elementId);
    if (el) el.innerHTML = `<div class="status ${type}">${msg}</div>`;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
